<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        .test-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        #logs {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîß WebRTC Connection Test</h1>
    
    <div class="test-section">
        <h3>üì° Server Connection Test</h3>
        <button onclick="testServerConnection()">Test Server Connection</button>
        <div id="serverStatus"></div>
    </div>
    
    <div class="test-section">
        <h3>üîå Socket.io Connection Test</h3>
        <button onclick="testSocketConnection()">Test Socket Connection</button>
        <div id="socketStatus"></div>
    </div>
    
    <div class="test-section">
        <h3>üìã Active Sessions Test</h3>
        <button onclick="testActiveSessions()">Check Active Sessions</button>
        <div id="sessionsStatus"></div>
    </div>
    
    <div class="test-section">
        <h3>üé• WebRTC Test</h3>
        <button onclick="testWebRTC()">Test WebRTC Offer/Answer</button>
        <div id="webrtcStatus"></div>
    </div>
    
    <div class="test-section">
        <h3>üìä Debug Logs</h3>
        <button onclick="clearLogs()">Clear Logs</button>
        <div id="logs"></div>
    </div>

    <script src="http://10.10.46.182:8000/socket.io/socket.io.js"></script>
    <script>
        let socket = null;
        const serverUrl = 'http://10.10.46.182:8000';
        
        function log(message) {
            const logs = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            logs.innerHTML += `[${time}] ${message}<br>`;
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }
        
        function setStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${message}</div>`;
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        async function testServerConnection() {
            log('üîç Testing server connection...');
            setStatus('serverStatus', 'üîÑ Testing server connection...', 'info');
            
            try {
                const response = await fetch(`${serverUrl}/api/stats`);
                const data = await response.json();
                
                if (data.success) {
                    setStatus('serverStatus', `‚úÖ Server connected! Students: ${data.stats.totalStudents}`, 'success');
                    log('‚úÖ Server connection successful');
                } else {
                    setStatus('serverStatus', '‚ö†Ô∏è Server responded but with errors', 'error');
                    log('‚ö†Ô∏è Server error response');
                }
            } catch (error) {
                setStatus('serverStatus', `‚ùå Server connection failed: ${error.message}`, 'error');
                log(`‚ùå Server connection error: ${error.message}`);
            }
        }
        
        function testSocketConnection() {
            log('üîç Testing Socket.io connection...');
            setStatus('socketStatus', 'üîÑ Connecting to Socket.io...', 'info');
            
            if (socket) {
                socket.disconnect();
            }
            
            socket = io(serverUrl);
            
            socket.on('connect', () => {
                setStatus('socketStatus', `‚úÖ Socket connected! ID: ${socket.id}`, 'success');
                log(`‚úÖ Socket connected: ${socket.id}`);
                
                // Register as admin for testing
                socket.emit('register-admin');
                log('üì° Registered as admin for testing');
            });
            
            socket.on('disconnect', () => {
                setStatus('socketStatus', '‚ùå Socket disconnected', 'error');
                log('‚ùå Socket disconnected');
            });
            
            socket.on('connect_error', (error) => {
                setStatus('socketStatus', `‚ùå Socket connection error: ${error.message}`, 'error');
                log(`‚ùå Socket error: ${error.message}`);
            });
        }
        
        async function testActiveSessions() {
            log('üîç Testing active sessions...');
            setStatus('sessionsStatus', 'üîÑ Fetching active sessions...', 'info');
            
            try {
                const response = await fetch(`${serverUrl}/api/active-sessions/all`);
                const data = await response.json();
                
                if (data.success && data.sessions) {
                    const sessions = data.sessions;
                    setStatus('sessionsStatus', 
                        `‚úÖ Found ${sessions.length} active sessions<br>` +
                        sessions.map(s => `‚Ä¢ ${s.studentName} (${s._id})`).join('<br>'), 
                        'success'
                    );
                    log(`‚úÖ Active sessions: ${sessions.length}`);
                    sessions.forEach(s => log(`  - ${s.studentName}: ${s._id}`));
                } else {
                    setStatus('sessionsStatus', '‚ö†Ô∏è No active sessions found', 'info');
                    log('‚ö†Ô∏è No active sessions');
                }
            } catch (error) {
                setStatus('sessionsStatus', `‚ùå Failed to fetch sessions: ${error.message}`, 'error');
                log(`‚ùå Sessions fetch error: ${error.message}`);
            }
        }
        
        function testWebRTC() {
            log('üîç Testing WebRTC functionality...');
            setStatus('webrtcStatus', 'üîÑ Testing WebRTC...', 'info');
            
            if (!socket || !socket.connected) {
                setStatus('webrtcStatus', '‚ùå Socket not connected. Test socket connection first.', 'error');
                return;
            }
            
            // Listen for WebRTC events
            socket.on('webrtc-answer', (data) => {
                log(`üìπ Received WebRTC answer from session: ${data.sessionId}`);
                setStatus('webrtcStatus', '‚úÖ WebRTC answer received! Connection should work.', 'success');
            });
            
            socket.on('webrtc-ice-candidate', (data) => {
                log(`üßä Received ICE candidate from session: ${data.sessionId}`);
            });
            
            socket.on('offer-received', (data) => {
                log(`üì• Kiosk acknowledged offer for session: ${data.sessionId}`);
            });
            
            // Test by requesting active sessions and trying to connect to first one
            fetch(`${serverUrl}/api/active-sessions/all`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.sessions && data.sessions.length > 0) {
                        const session = data.sessions[0];
                        log(`üéØ Testing WebRTC with session: ${session._id}`);
                        
                        // Create a test offer
                        const pc = new RTCPeerConnection({
                            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                        });
                        
                        pc.createOffer()
                            .then(offer => {
                                log('üì§ Sending test WebRTC offer...');
                                socket.emit('admin-offer', {
                                    offer: offer,
                                    sessionId: session._id,
                                    adminSocketId: socket.id
                                });
                                
                                setTimeout(() => {
                                    setStatus('webrtcStatus', '‚è≥ Offer sent. Check logs for response...', 'info');
                                }, 1000);
                            })
                            .catch(error => {
                                log(`‚ùå WebRTC offer creation failed: ${error.message}`);
                                setStatus('webrtcStatus', `‚ùå WebRTC test failed: ${error.message}`, 'error');
                            });
                    } else {
                        setStatus('webrtcStatus', '‚ùå No active sessions to test with. Login to kiosk first.', 'error');
                        log('‚ùå No sessions available for WebRTC test');
                    }
                })
                .catch(error => {
                    setStatus('webrtcStatus', `‚ùå Failed to get sessions: ${error.message}`, 'error');
                    log(`‚ùå Session fetch error: ${error.message}`);
                });
        }
        
        // Auto-run basic tests on page load
        window.addEventListener('load', () => {
            log('üöÄ WebRTC Connection Test Tool loaded');
            setTimeout(testServerConnection, 500);
        });
    </script>
</body>
</html>
