<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>üîí College Lab Kiosk</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

    <style>
        body {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            min-height: 100vh;
            overflow-y: auto;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
            padding: 20px 0;
        }
        .kiosk-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .login-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            margin: 20px auto;
        }
        .card-header {
            border-radius: 20px 20px 0 0;
        }
        .lock-icon {
            font-size: 4rem;
        }
        .system-info {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.1), rgba(253, 126, 20, 0.1));
            border-left: 5px solid #dc3545;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .demo-section {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(32, 201, 151, 0.1));
            border: 2px solid #28a745;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .connection-status {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 9999;
        }
        .status-connected { background: #28a745; color: white; }
        .status-disconnected { background: #dc3545; color: white; }
        .demo-btn {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            color: white;
            font-weight: bold;
            margin: 5px;
        }
        .demo-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }
        .btn-unlock {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 15px;
            width: 100%;
            color: white;
        }
        .btn-unlock:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(40, 167, 69, 0.4);
        }
        .btn-forgot {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            border: none;
            color: #000;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-forgot:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(255, 193, 7, 0.4);
            color: #000;
        }
        .session-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .session-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 25px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            text-align: center;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
        }
        .session-icon {
            font-size: 6rem;
            color: #28a745;
        }
        .duration-display {
            font-size: 3rem;
            font-weight: bold;
            color: #28a745;
            font-family: 'Courier New', monospace;
        }
        .debug-section {
            background: rgba(108, 117, 125, 0.1);
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
        }
        .forgot-password-section {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(253, 126, 20, 0.1));
            border: 2px solid #ffc107;
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div id="connectionStatus" class="connection-status status-disconnected">
        <i class="fas fa-circle"></i> Disconnected
    </div>

    <div id="loginScreen" class="kiosk-container">
        <div class="login-card">
            <div class="card-header bg-danger text-white text-center py-4">
                <div class="lock-icon mb-3">
                    <i class="fas fa-lock"></i>
                </div>
                <h2 class="mb-0"><strong>üñ•Ô∏è College Lab Registration System</strong></h2>
                <p class="mb-0 mt-2">Secure Student Kiosk Access</p>
            </div>
            <div class="card-body p-4">
                <div class="system-info">
                    <h5 class="text-danger mb-3"><i class="fas fa-info-circle"></i> System Information</h5>
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <strong>Computer Name:</strong> <span id="computerName">Loading...</span>
                        </div>
                        <div class="col-md-4 mb-2">
                            <strong>Lab ID:</strong> <span class="badge bg-danger">CC1</span>
                        </div>
                        <div class="col-md-4 mb-2">
                            <strong>System Number:</strong> <span id="systemNumberDisplay" class="badge bg-info">Loading...</span>
                        </div>
                        <div class="col-md-6 mb-2">
                            <strong>Current Time:</strong> <span id="currentTime" style="color: #28a745; font-weight: bold;">--:--:--</span>
                        </div>
                        <div class="col-md-6 mb-2">
                            <strong>Kiosk Mode:</strong> <span class="badge bg-warning">üîí ACTIVE</span>
                        </div>
                    </div>
                </div>

                <div class="demo-section">
                    <h5 class="text-success mb-3"><i class="fas fa-info-circle"></i> Getting Started</h5>
                    <p class="text-muted small mb-3">
                        <strong>New to the system?</strong> Contact your admin to get sample data setup and receive your one-time password.
                    </p>
                    <div class="d-flex justify-content-center flex-wrap">
                        <button class="btn demo-btn" onclick="showSystemInfo()">
                            <i class="fas fa-info"></i> System Info
                        </button>
                        <button class="btn demo-btn" onclick="testConnection()">
                            <i class="fas fa-wifi"></i> Test Connection
                        </button>
                        <button class="btn demo-btn" onclick="showHelp()">
                            <i class="fas fa-question-circle"></i> Help
                        </button>
                    </div>
                </div>

                <div id="errorAlert" class="alert alert-danger d-none" role="alert">
                    <i class="fas fa-exclamation-triangle"></i> <span id="errorMessage"></span>
                </div>

                <form id="loginForm">
                    <div class="mb-4">
                        <label class="form-label fw-bold"><i class="fas fa-user"></i> Student ID</label>
                        <input type="text" class="form-control form-control-lg" id="studentId" placeholder="Enter your Student ID" required />
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-bold"><i class="fas fa-key"></i> Password</label>
                        <input type="password" class="form-control form-control-lg" id="password" placeholder="Enter your Password" required />
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-bold"><i class="fas fa-desktop"></i> System Number</label>
                        <select class="form-select form-select-lg" id="systemNumber" required>
                            <option value="">Select System Number</option>
                            <option value="CC1-01">CC1-01</option>
                            <option value="CC1-02">CC1-02</option>
                            <option value="CC1-03">CC1-03</option>
                            <option value="CC1-04">CC1-04</option>
                            <option value="CC1-05">CC1-05</option>
                            <option value="CC1-06">CC1-06</option>
                            <option value="CC1-07">CC1-07</option>
                            <option value="CC1-08">CC1-08</option>
                            <option value="CC1-09">CC1-09</option>
                            <option value="CC1-10">CC1-10</option>
                            <option value="CC2-01">CC2-01</option>
                            <option value="CC2-02">CC2-02</option>
                            <option value="CC2-03">CC2-03</option>
                            <option value="CC2-04">CC2-04</option>
                            <option value="CC2-05">CC2-05</option>
                            <option value="CC2-06">CC2-06</option>
                            <option value="CC2-07">CC2-07</option>
                            <option value="CC2-08">CC2-08</option>
                            <option value="CC2-09">CC2-09</option>
                            <option value="CC2-10">CC2-10</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-unlock btn-lg">
                        <i class="fas fa-unlock"></i> Unlock & Start Session
                    </button>
                    
                    <!-- NEW: Forgot Password Button -->
                    <button type="button" class="btn btn-forgot btn-lg mt-3 w-100" onclick="showForgotPassword()">
                        <i class="fas fa-key"></i> Forgot Password?
                    </button>
                    
                    <!-- NEW: First-time Sign-in Button -->
                    <button type="button" class="btn btn-warning btn-lg mt-2 w-100" onclick="goToFirstTimeSignin()">
                        <i class="fas fa-user-plus"></i> First-time Sign-in
                    </button>
                </form>

                <!-- NEW: Help Section -->
                <div class="forgot-password-section">
                    <h6 class="text-warning mb-2"><i class="fas fa-lightbulb"></i> Need Help?</h6>
                    <p class="text-muted small mb-2">
                        <strong>First-time Sign-in:</strong> If you're logging in for the first time, click "First-time Sign-in" to set up your password.
                    </p>
                    <p class="text-muted small mb-0">
                        <strong>Forgot Password:</strong> If you forgot your password, click "Forgot Password?" and follow the email verification process.
                    </p>
                </div>

                <div class="debug-section mt-4">
                    <h6 class="text-muted mb-2"><i class="fas fa-bug"></i> Debug Console</h6>
                    <div id="debugLog" style="color: #6c757d;">
                        System initialized. Waiting for login...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="sessionModal" class="session-modal">
        <div class="session-card">
            <div class="session-icon mb-4">
                <i class="fas fa-check-circle"></i>
            </div>
            <h1 class="mb-3 text-success"><strong>Session Active!</strong></h1>
            <h3 class="mb-4">Welcome, <span id="sessionStudentName" class="text-primary">Student</span>!</h3>
            
            <div class="row mb-4">
                <div class="col-md-4">
                    <h6 class="text-muted">Student ID</h6>
                    <p class="fw-bold" id="sessionStudentId">---</p>
                </div>
                <div class="col-md-4">
                    <h6 class="text-muted">System</h6>
                    <p class="fw-bold" id="sessionSystem">---</p>
                </div>
                <div class="col-md-4">
                    <h6 class="text-muted">Login Time</h6>
                    <p class="fw-bold" id="sessionLoginTime">---</p>
                </div>
            </div>

            <div class="bg-light p-4 rounded-3 mb-4">
                <h5 class="text-muted mb-2">Session Duration</h5>
                <div class="duration-display" id="sessionDuration">00:00:00</div>
            </div>

            <div class="alert alert-info mb-4">
                <i class="fas fa-video"></i> Your screen is being monitored by the admin dashboard.
            </div>

            <button class="btn btn-danger btn-lg px-5" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> End Session & Logout
            </button>
        </div>
    </div>

    <!-- CRITICAL: Load scripts in correct order at the END -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="renderer.js"></script>

    <script>
        // NEW: Helper Functions
        function showSystemInfo() {
            const computerName = document.getElementById('computerName').textContent;
            const systemNumber = document.getElementById('systemNumberDisplay').textContent;
            
            alert(`üñ•Ô∏è System Information:

Computer Name: ${computerName}
System Number: ${systemNumber}
Lab ID: CC1
Current Time: ${new Date().toLocaleString()}

Status: Kiosk Mode Active
Server: Connected to Lab Management System`);
            
            addDebugLog('System information displayed');
        }

        function testConnection() {
            addDebugLog('Testing connection to server...');
            
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`‚úÖ Connection Test Successful!

Server Status: Online
Total Students: ${data.stats.totalStudents}
Students with Passwords: ${data.stats.passwordsSet}
Pending Setup: ${data.stats.pendingPasswords}

Connection: Working properly`);
                        addDebugLog('‚úÖ Connection test successful');
                    } else {
                        alert('‚ö†Ô∏è Server responded but with errors');
                        addDebugLog('‚ö†Ô∏è Server error in connection test');
                    }
                })
                .catch(error => {
                    alert(`‚ùå Connection Test Failed:

Error: ${error.message}

Please check:
- Server is running
- Network connection is working
- Contact admin if problem persists`);
                    addDebugLog(`‚ùå Connection test failed: ${error.message}`);
                });
        }

        function showHelp() {
            alert(`üÜò Lab Kiosk Help:

üìù FIRST-TIME USERS:
1. Get your one-time password from admin
2. Click "First-time Sign-in"
3. Enter Student ID and one-time password
4. Create your permanent password

üîë EXISTING USERS:
1. Enter your Student ID and password
2. Select your system number
3. Click "Unlock & Start Session"

‚ùì FORGOT PASSWORD:
1. Click "Forgot Password?"
2. Enter Student ID (Roll Number)
3. Enter your email address
4. Check email for OTP code
5. Enter OTP and create new password

üìû NEED HELP?
Contact your lab administrator for assistance.`);
            
            addDebugLog('Help information displayed');
        }

        let sessionStartTime = null;
        let durationInterval = null;
        let currentSessionId = null;

        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString();
        }
        setInterval(updateTime, 1000);
        updateTime();

        function addDebugLog(message) {
            const debugLog = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            debugLog.innerHTML += `<br>[${timestamp}] ${message}`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        async function loadSystemInfo() {
            try {
                const sysInfo = await window.electronAPI.getSystemInfo();
                document.getElementById('computerName').textContent = sysInfo.hostname;
                
                // Try to detect system number from hostname or environment
                const systemNumber = detectSystemNumber(sysInfo.hostname);
                document.getElementById('systemNumberDisplay').textContent = systemNumber;
                
                addDebugLog(`System loaded: ${sysInfo.hostname} (${systemNumber})`);
            } catch (error) {
                console.error('Error loading system info:', error);
                document.getElementById('systemNumberDisplay').textContent = 'Unknown';
                addDebugLog(`Error: ${error.message}`);
            }
        }

        function detectSystemNumber(hostname) {
            // Try to extract system number from hostname
            const patterns = [
                /CC1-?(\d+)/i,          // CC1-01, CC101
                /CC2-?(\d+)/i,          // CC2-01, CC201
                /PC-?(\d+)/i,           // PC-01, PC01
                /LAB-?\d+-?(\d+)/i,     // LAB-01-01, LAB1-1
                /SYSTEM-?(\d+)/i,       // SYSTEM-01
                /COMP-?(\d+)/i,         // COMP-01
                /(\d+)$/                // Ends with number
            ];
            
            for (const pattern of patterns) {
                const match = hostname.match(pattern);
                if (match) {
                    const num = parseInt(match[1]);
                    // Check if it's CC1 or CC2 pattern
                    if (hostname.match(/CC1/i)) {
                        return `CC1-${String(num).padStart(2, '0')}`;
                    } else if (hostname.match(/CC2/i)) {
                        return `CC2-${String(num).padStart(2, '0')}`;
                    } else {
                        return `CC1-${String(num).padStart(2, '0')}`;
                    }
                }
            }
            
            // Fallback: generate based on hostname hash
            let hash = 0;
            for (let i = 0; i < hostname.length; i++) {
                hash = ((hash << 5) - hash + hostname.charCodeAt(i)) & 0xffffffff;
            }
            const systemNum = (Math.abs(hash) % 10) + 1;
            return `CC1-${String(systemNum).padStart(2, '0')}`;
        }

        loadSystemInfo();

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const errorAlert = document.getElementById('errorAlert');
            const errorMessage = document.getElementById('errorMessage');
            errorAlert.classList.add('d-none');

            const credentials = {
                studentId: document.getElementById('studentId').value.trim(),
                password: document.getElementById('password').value,
                systemNumber: document.getElementById('systemNumber').value,
            };

            addDebugLog(`Attempting login for ${credentials.studentId}...`);

            try {
                const result = await window.electronAPI.studentLogin(credentials);

                if (result.success) {
                    addDebugLog(`‚úÖ Login successful! Session: ${result.sessionId}`);
                    currentSessionId = result.sessionId;

                    document.getElementById('sessionStudentName').textContent = result.student.name;
                    document.getElementById('sessionStudentId').textContent = result.student.studentId;
                    document.getElementById('sessionSystem').textContent = credentials.systemNumber;
                    document.getElementById('sessionLoginTime').textContent = new Date().toLocaleTimeString();

                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('sessionModal').style.display = 'flex';

                    sessionStartTime = Date.now();
                    startDurationCounter();
                } else {
                    errorMessage.textContent = result.error || 'Login failed';
                    errorAlert.classList.remove('d-none');
                    addDebugLog(`‚ùå Login failed: ${result.error}`);
                }
            } catch (error) {
                console.error('Login error:', error);
                errorMessage.textContent = 'An error occurred: ' + error.message;
                errorAlert.classList.remove('d-none');
                addDebugLog(`‚ùå Login error: ${error.message}`);
            }
        });

        function startDurationCounter() {
            durationInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
                const hours = String(Math.floor(elapsed / 3600)).padStart(2, '0');
                const minutes = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0');
                const seconds = String(elapsed % 60).padStart(2, '0');
                document.getElementById('sessionDuration').textContent = `${hours}:${minutes}:${seconds}`;
            }, 1000);
        }

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            addDebugLog('Logout initiated...');

            try {
                const result = await window.electronAPI.studentLogout();

                if (result.success) {
                    addDebugLog('‚úÖ Logout successful');

                    if (durationInterval) {
                        clearInterval(durationInterval);
                        durationInterval = null;
                    }

                    document.getElementById('loginForm').reset();
                    document.getElementById('sessionModal').style.display = 'none';
                    document.getElementById('loginScreen').style.display = 'flex';

                    sessionStartTime = null;
                    currentSessionId = null;
                } else {
                    alert('Logout failed: ' + (result.error || 'Unknown error'));
                    addDebugLog(`‚ùå Logout failed: ${result.error}`);
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('Logout error: ' + error.message);
                addDebugLog(`‚ùå Logout error: ${error.message}`);
            }
        });

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.className = 'connection-status status-connected';
                statusEl.innerHTML = '<i class="fas fa-circle"></i> Connected';
                addDebugLog('‚úÖ Socket connected');
            } else {
                statusEl.className = 'connection-status status-disconnected';
                statusEl.innerHTML = '<i class="fas fa-circle"></i> Disconnected';
            }
        }

        updateConnectionStatus(false);

        // NEW: Navigation Functions
        function goToFirstTimeSignin() {
            addDebugLog('üë§ Navigating to first-time sign-in page');
            window.location.href = 'first-signin.html';
        }

        // NEW: Enhanced Forgot Password Functions with OTP verification
        function showForgotPassword() {
            addDebugLog('üîë Forgot password initiated');
            showForgotPasswordStep1();
        }

        function showForgotPasswordStep1() {
            // Create modal dialog for student ID input
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.innerHTML = `
                <div style="background:white;padding:30px;border-radius:15px;max-width:400px;width:90%;">
                    <h4>üÜî Enter Student ID</h4>
                    <input type="text" id="fpStudentId" placeholder="Student ID (e.g., IT2021005)" style="width:100%;padding:10px;margin:10px 0;border:1px solid #ddd;border-radius:5px;">
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button onclick="document.body.removeChild(this.closest('div').parentElement)" style="flex:1;padding:10px;background:#6c757d;color:white;border:none;border-radius:5px;">Cancel</button>
                        <button onclick="submitStudentId()" style="flex:1;padding:10px;background:#007bff;color:white;border:none;border-radius:5px;">Next</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('fpStudentId').focus();
        }
        
        function submitStudentId() {
            const studentId = document.getElementById('fpStudentId').value.trim();
            if (!studentId) return;
            
            document.body.removeChild(document.body.lastElementChild);
            addDebugLog(`üîç Verifying student ID: ${studentId}`);
            initiateForgotPassword(studentId.toUpperCase());
        }
        
        function showEmailInput(studentId, studentName, maskedEmail) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.innerHTML = `
                <div style="background:white;padding:30px;border-radius:15px;max-width:450px;width:90%;">
                    <h4>üìß Enter Email Address</h4>
                    <p><strong>Student:</strong> ${studentName}<br>
                    <strong>Registered:</strong> ${maskedEmail}</p>
                    <input type="email" id="fpEmail" placeholder="Enter your complete email address" style="width:100%;padding:10px;margin:10px 0;border:1px solid #ddd;border-radius:5px;">
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button onclick="document.body.removeChild(this.closest('div').parentElement)" style="flex:1;padding:10px;background:#6c757d;color:white;border:none;border-radius:5px;">Cancel</button>
                        <button onclick="submitEmail('${studentId}', '${studentName}')" style="flex:1;padding:10px;background:#007bff;color:white;border:none;border-radius:5px;">Send OTP</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('fpEmail').focus();
        }
        
        function submitEmail(studentId, studentName) {
            const email = document.getElementById('fpEmail').value.trim();
            if (!email) return;
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert("‚ùå Invalid email format!\n\nPlease enter a valid email address.");
                return;
            }
            
            document.body.removeChild(document.body.lastElementChild);
            sendOTPToEmail(studentId, email, studentName);
        }

        async function initiateForgotPassword(studentId) {
            try {
                const response = await fetch('/api/forgot-password-initiate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ studentId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addDebugLog(`‚úÖ Student verified: ${data.studentName}`);
                    showEmailInput(studentId, data.studentName, data.maskedEmail);
                    
                } else {
                    alert(`‚ùå Student Verification Failed:

${data.error}

Please check:
- Student ID (Roll Number) is correct
- You have already set a password previously
- Contact admin if you need help`);
                    addDebugLog(`‚ùå Student verification error: ${data.error}`);
                }
                
            } catch (error) {
                alert(`‚ùå Network error occurred:\n\n${error.message}\n\nPlease ensure server is running and try again.`);
                addDebugLog(`‚ùå Network error: ${error.message}`);
            }
        }

        async function sendOTPToEmail(studentId, email, studentName) {
            try {
                addDebugLog(`üìß Sending OTP to email: ${email}`);
                
                const response = await fetch('/api/forgot-password-send-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ studentId, email })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addDebugLog(`‚úÖ OTP sent to ${email}`);
                    
                    alert(`üìß OTP Sent Successfully!

Dear ${studentName},

An OTP (One-Time Password) has been sent to:
${email}

Please check your email and enter the 6-digit OTP in the next step.

Note: OTP will expire in 10 minutes.`);
                    
                    // Now ask for OTP and new password
                    verifyOTPAndResetPassword(studentId, email, studentName);
                    
                } else {
                    alert(`‚ùå Failed to Send OTP:

${data.error}

Please check:
- Email address is correct
- Email matches your registered email
- Try again with correct information`);
                    addDebugLog(`‚ùå OTP send error: ${data.error}`);
                }
                
            } catch (error) {
                alert(`‚ùå Network error occurred:\n\n${error.message}\n\nPlease ensure server is running and try again.`);
                addDebugLog(`‚ùå Network error: ${error.message}`);
            }
        }

        async function verifyOTPAndResetPassword(studentId, email, studentName) {
            showOTPInput(studentId, email, studentName);
        }
        
        function showOTPInput(studentId, email, studentName) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.innerHTML = `
                <div style="background:white;padding:30px;border-radius:15px;max-width:450px;width:90%;">
                    <h4>üîê Enter OTP & New Password</h4>
                    <p><strong>Student:</strong> ${studentName}<br>
                    <strong>Email:</strong> ${email}</p>
                    <input type="text" id="fpOTP" placeholder="Enter 6-digit OTP" maxlength="6" style="width:100%;padding:10px;margin:10px 0;border:1px solid #ddd;border-radius:5px;">
                    <input type="password" id="fpNewPassword" placeholder="Enter new password (min 6 chars)" style="width:100%;padding:10px;margin:10px 0;border:1px solid #ddd;border-radius:5px;">
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button onclick="document.body.removeChild(this.closest('div').parentElement)" style="flex:1;padding:10px;background:#6c757d;color:white;border:none;border-radius:5px;">Cancel</button>
                        <button onclick="submitOTPAndPassword('${studentId}', '${email}', '${studentName}')" style="flex:1;padding:10px;background:#28a745;color:white;border:none;border-radius:5px;">Reset Password</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('fpOTP').focus();
        }
        
        function submitOTPAndPassword(studentId, email, studentName) {
            const otp = document.getElementById('fpOTP').value.trim();
            const newPassword = document.getElementById('fpNewPassword').value;
            
            if (!otp) {
                alert("Please enter the OTP");
                return;
            }
            
            if (!/^\d{6}$/.test(otp)) {
                alert("‚ùå Invalid OTP format!\n\nOTP must be exactly 6 digits.\nExample: 123456");
                return;
            }
            
            if (!newPassword) {
                alert("Please enter a new password");
                return;
            }
            
            if (newPassword.length < 6) {
                alert("‚ùå Password too short!\n\nPassword must be at least 6 characters long.");
                return;
            }
            
            document.body.removeChild(document.body.lastElementChild);
            finalizePasswordReset(studentId, email, otp, newPassword, studentName);
        }
        
        async function finalizePasswordReset(studentId, email, otp, newPassword, studentName) {
            
            // Verify OTP and reset password
            try {
                addDebugLog(`üîÑ Verifying OTP and resetting password for: ${studentId}`);
                
                const response = await fetch('/api/forgot-password-verify-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        studentId, 
                        email, 
                        otp, 
                        newPassword 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addDebugLog(`‚úÖ Password reset successful for ${studentId}`);
                    
                    alert(`‚úÖ Password Reset Successful!

Dear ${data.student.name},

Your password has been successfully reset!

You can now login with:
- Student ID: ${data.student.studentId}
- New Password: [The password you just set]

Click OK to return to login.`);
                    
                    // Auto-fill the student ID in login form
                    document.getElementById('studentId').value = studentId;
                    document.getElementById('password').focus();
                    
                    addDebugLog(`Student ID auto-filled: ${studentId}`);
                    
                } else {
                    alert(`‚ùå Password Reset Failed:

${data.error}

Please check:
- OTP is correct and not expired
- All information is accurate
- Try the process again if needed`);
                    addDebugLog(`‚ùå Password reset error: ${data.error}`);
                }
                
            } catch (error) {
                alert(`‚ùå Network error occurred:\n\n${error.message}\n\nPlease ensure server is running and try again.`);
                addDebugLog(`‚ùå Network error: ${error.message}`);
            }
        }
    </script>
</body>
</html>
