<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üñ•Ô∏è Lab Management System - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .header .subtitle {
            opacity: 0.9;
            font-size: 1rem;
        }
        
        .main-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .control-panel {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .control-panel h2 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            font-size: 1.4rem;
        }
        
        .session-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .students-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .student-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .student-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 8px rgba(0,123,255,0.1);
        }
        
        .student-card.monitoring {
            border-color: #28a745;
            background: #f8fff9;
        }
        
        .student-info h3 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .student-info p {
            color: #6c757d;
            margin: 0.25rem 0;
            font-size: 0.9rem;
        }
        
        .video-container {
            width: 100%;
            height: 180px;
            background: #000;
            border-radius: 6px;
            margin: 1rem 0;
            position: relative;
            overflow: hidden;
        }
        
        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .screen-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .student-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .student-controls .btn {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }
        
        .no-students {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 3rem;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-online {
            background: #28a745;
        }
        
        .status-offline {
            background: #dc3545;
        }
        
        .fullscreen-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .fullscreen-modal.active {
            display: flex;
        }
        
        .fullscreen-content {
            position: relative;
            width: 90vw;
            height: 90vh;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .fullscreen-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .close-fullscreen {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 11;
        }
        
        .close-fullscreen:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üñ•Ô∏è Lab Management System</h1>
        <p class="subtitle">Real-time Student Monitoring & Session Management</p>
    </div>

    <div class="main-container">
        <!-- Control Panel -->
        <div class="control-panel">
            <h2>üìä Session Control</h2>
            
            <div class="session-controls">
                <button class="btn btn-success" id="startSessionBtn" onclick="startLabSession()">
                    üöÄ Start Lab Session
                </button>
                <button class="btn btn-danger" id="endSessionBtn" onclick="endLabSession()" disabled>
                    üõë End Lab Session
                </button>
                <button class="btn btn-primary" onclick="refreshStudentList()">
                    üîÑ Refresh Students
                </button>
                <button class="btn btn-secondary" onclick="exportSessionData()">
                    üìä Export CSV
                </button>
                <button class="btn btn-secondary" onclick="debugSessionData()" style="background: #ffc107; color: #000;">
                    üîç Debug Data
                </button>
                <button class="btn btn-warning" onclick="forceClearSessions()" style="background: #dc3545; color: white;">
                    üßπ Force Clear All
                </button>
            </div>

            <!-- Session Info -->
            <div id="session-info" style="display: none; background: #e8f5e8; border: 2px solid #28a745; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <h3 style="color: #155724; margin-bottom: 0.5rem;">üìö Current Lab Session</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                    <div><strong>Subject:</strong> <span id="current-subject">-</span></div>
                    <div><strong>Faculty:</strong> <span id="current-faculty">-</span></div>
                    <div><strong>Year:</strong> <span id="current-year">-</span></div>
                    <div><strong>Department:</strong> <span id="current-department">-</span></div>
                    <div><strong>Section:</strong> <span id="current-section">-</span></div>
                    <div><strong>Duration:</strong> <span id="current-duration">-</span></div>
                    <div><strong>Started:</strong> <span id="current-start-time">-</span></div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalStudents">0</div>
                    <div class="stat-label">Total Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeStudents">0</div>
                    <div class="stat-label">Active Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="monitoringStudents">0</div>
                    <div class="stat-label">Being Monitored</div>
                </div>
            </div>
        </div>

        <!-- Students Section -->
        <div class="students-section">
            <h2>üë• Active Students</h2>
            <div id="studentsGrid" class="students-grid">
                <div class="no-students">
                    üì± No students connected. Students need to login via kiosk first.
                </div>
            </div>
        </div>
    </div>

    <!-- Fullscreen Modal -->
    <div id="fullscreen-modal" class="fullscreen-modal">
        <button class="close-fullscreen" onclick="closeFullscreen()">√ó</button>
        <div class="fullscreen-content">
            <video id="fullscreen-video" class="fullscreen-video" autoplay muted></video>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Global variables
        let socket;
        let connectedStudents = new Map();
        let monitoringConnections = new Map();
        let sessionActive = false;
        let currentLabSession = null;
        let sessionTimer = null;
        let sessionEndTime = null;

        // Initialize socket connection
        function initializeSocket() {
            console.log('üöÄ Admin dashboard loading...');
            
            socket = io('http://10.10.194.103:8000');
            
            socket.on('connect', () => {
                console.log('‚úÖ Admin dashboard connected:', socket.id);
                socket.emit('register-admin');
                loadActiveStudents();
            });
            
            socket.on('disconnect', () => {
                console.log('‚ùå Admin dashboard disconnected');
            });
            
            socket.on('connect_error', (error) => {
                console.error('‚ùå Connection error:', error);
            });
            
            // Listen for student events
            socket.on('session-created', (sessionData) => {
                console.log('üì± New session created:', sessionData);
                addStudentToGrid(sessionData);
                updateStats();
            });
            
            socket.on('session-ended', (sessionData) => {
                console.log('üì± Session ended:', sessionData);
                removeStudentFromGrid(sessionData.sessionId);
                updateStats();
            });
            
            socket.on('active-sessions', (sessions) => {
                console.log('üìã Active sessions received:', sessions);
                displayActiveSessions(sessions);
            });
            
            // WebRTC signaling
            socket.on('webrtc-answer', ({ answer, sessionId }) => {
                console.log('üìπ WebRTC answer received for session:', sessionId);
                handleWebRTCAnswer(answer, sessionId);
            });
            
            socket.on('webrtc-ice-candidate', ({ candidate, sessionId }) => {
                console.log('üßä ‚úÖ ADMIN RECEIVED ICE CANDIDATE from kiosk for session:', sessionId, candidate.type);
                handleICECandidate(candidate, sessionId);
            });
        }

        // Load active students
        function loadActiveStudents() {
            if (socket && socket.connected) {
                socket.emit('get-active-sessions');
            }
        }

        // Display active sessions
        function displayActiveSessions(sessions) {
            const grid = document.getElementById('studentsGrid');
            
            if (!sessions || sessions.length === 0) {
                grid.innerHTML = '<div class="no-students">üì± No students connected. Students need to login via kiosk first.</div>';
                connectedStudents.clear();
                updateStats();
                return;
            }
            
            grid.innerHTML = '';
            connectedStudents.clear();
            
            console.log('üé• AUTO-STARTING screen mirroring for all sessions...');
            
            sessions.forEach(session => {
                const sessionId = session._id || session.sessionId || session.id;
                if (sessionId) {
                    connectedStudents.set(sessionId, session);
                    
                    // Create the student card first
                    addStudentToGrid(session);
                    
                    // AUTO-START monitoring for this session
                    setTimeout(() => {
                        console.log('üé• AUTO-STARTING monitoring for session:', sessionId);
                        startMonitoring(sessionId);
                    }, 1000); // Small delay to ensure DOM is ready
                }
            });
            
            updateStats();
        }

        // Add student to grid
        function addStudentToGrid(sessionData) {
            const sessionId = sessionData._id || sessionData.sessionId || sessionData.id;
            
            if (!sessionId) {
                console.error('‚ùå No valid session ID found:', sessionData);
                return;
            }
            
            // Remove existing card if present
            const existingCard = document.getElementById(`student-${sessionId}`);
            if (existingCard) {
                existingCard.remove();
            }
            
            const studentCard = document.createElement('div');
            studentCard.className = 'student-card';
            studentCard.id = `student-${sessionId}`;
            
            const loginTime = new Date(sessionData.loginTime).toLocaleTimeString();
            
            studentCard.innerHTML = `
                <div class="student-info">
                    <div class="student-name">üë§ ${sessionData.studentName}</div>
                    <div class="student-details">
                        <div><strong>ID:</strong> ${sessionData.studentId}</div>
                        <div><strong>System:</strong> ${sessionData.systemNumber}</div>
                        <div><strong>Login:</strong> ${loginTime}</div>
                    </div>
                </div>
                <div class="video-container" id="video-${sessionId}">
                    <div class="no-video">üîÑ Auto-connecting to screen...</div>
                </div>
                <div class="student-actions">
                    <button onclick="expandVideo('${sessionId}')" class="btn-expand">üîç Expand</button>
                    <button onclick="stopMonitoring('${sessionId}')" class="btn-stop">üõë Stop Watching</button>
                    <div class="connection-status" id="status-${sessionId}">üîÑ Connecting...</div>
                </div>
            `;
            
            const grid = document.getElementById('studentsGrid');
            if (grid.querySelector('.no-students')) {
                grid.innerHTML = '';
            }
            grid.appendChild(studentCard);
            
            connectedStudents.set(sessionId, sessionData);
        }

        // Remove student from grid
        function removeStudentFromGrid(sessionId) {
            const studentCard = document.getElementById(`student-${sessionId}`);
            if (studentCard) {
                studentCard.remove();
            }
            
            connectedStudents.delete(sessionId);
            
            // Clean up monitoring connection
            if (monitoringConnections.has(sessionId)) {
                monitoringConnections.get(sessionId).close();
                monitoringConnections.delete(sessionId);
            }
            
            // Show no students message if grid is empty
            const grid = document.getElementById('studentsGrid');
            if (grid.children.length === 0) {
                grid.innerHTML = '<div class="no-students">üì± No students connected. Students need to login via kiosk first.</div>';
            }
        }

        // Start monitoring a student
        async function startMonitoring(sessionId) {
            try {
                console.log('üìπ Starting monitoring for session:', sessionId);
                
                const videoContainer = document.getElementById(`video-${sessionId}`);
                if (!videoContainer) {
                    throw new Error('Video container not found');
                }
                
                // Create video element
                const video = document.createElement('video');
                video.autoplay = true;
                video.muted = true;
                video.style.width = '100%';
                video.style.height = '100%';
                video.style.objectFit = 'cover';
                
                videoContainer.innerHTML = '';
                videoContainer.appendChild(video);
                
                // Create WebRTC peer connection with multiple STUN servers
                const peerConnection = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        { urls: 'stun:stun3.l.google.com:19302' },
                        { urls: 'stun:stun4.l.google.com:19302' }
                    ],
                    iceCandidatePoolSize: 10
                });
                
                console.log('üîó Created peer connection with enhanced ICE configuration');
                
                // Handle remote stream
                let trackReceived = false;
                peerConnection.ontrack = (event) => {
                    trackReceived = true;
                    console.log('üì∫ ‚úÖ RECEIVED REMOTE STREAM for session:', sessionId, event);
                    console.log('üì∫ Stream tracks:', event.streams[0].getTracks());
                    video.srcObject = event.streams[0];
                    
                    // Add video event listeners for debugging
                    video.onloadedmetadata = () => {
                        console.log('‚úÖ Video metadata loaded for session:', sessionId);
                    };
                    
                    video.onplay = () => {
                        console.log('‚ñ∂Ô∏è Video started playing for session:', sessionId);
                    };
                    
                    video.onerror = (error) => {
                        console.error('‚ùå Video error for session:', sessionId, error);
                    };
                };
                
                // Check if track is received within 10 seconds
                setTimeout(() => {
                    if (!trackReceived) {
                        console.error('‚ùå ‚ùå NO VIDEO TRACK RECEIVED within 10 seconds for session:', sessionId);
                        console.error('‚ùå This means the kiosk is not sending video tracks properly');
                        console.error('‚ùå Connection state:', peerConnection.connectionState);
                        console.error('‚ùå ICE state:', peerConnection.iceConnectionState);
                    }
                }, 10000);
                
                // Handle ICE candidates
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log('üßä ‚úÖ ADMIN SENDING ICE CANDIDATE for session:', sessionId, event.candidate.type);
                        socket.emit('webrtc-ice-candidate', {
                            candidate: event.candidate,
                            sessionId: sessionId
                        });
                        console.log('üßä ‚úÖ Admin ICE candidate sent to server');
                    } else {
                        console.log('üßä ‚úÖ Admin ICE gathering complete for session:', sessionId);
                    }
                };
                
                // Monitor connection state
                peerConnection.onconnectionstatechange = () => {
                    console.log('üîÑ Connection state changed for session:', sessionId, peerConnection.connectionState);
                    if (peerConnection.connectionState === 'connected') {
                        console.log('‚úÖ ‚úÖ WebRTC CONNECTED for session:', sessionId, '- Video should be flowing now!');
                    } else if (peerConnection.connectionState === 'failed') {
                        console.error('‚ùå WebRTC connection failed for session:', sessionId);
                    }
                };
                
                // Monitor ICE connection state
                peerConnection.oniceconnectionstatechange = () => {
                    console.log('üßä ICE connection state changed for session:', sessionId, peerConnection.iceConnectionState);
                    if (peerConnection.iceConnectionState === 'connected') {
                        console.log('‚úÖ ICE CONNECTED for session:', sessionId);
                    }
                };
                
                // Create offer with specific constraints to ensure media
                const offer = await peerConnection.createOffer({
                    offerToReceiveVideo: true,
                    offerToReceiveAudio: false
                });
                await peerConnection.setLocalDescription(offer);
                console.log('‚úÖ ADMIN: Offer created and local description set');
                
                // Send offer to kiosk
                console.log('üì§ ADMIN: Sending offer to kiosk for session:', sessionId);
                socket.emit('admin-offer', {
                    offer: offer,
                    sessionId: sessionId,
                    adminSocketId: socket.id
                });
                console.log('‚úÖ ADMIN: Offer sent to kiosk');
                
                // Update status
                const statusDiv = document.getElementById(`status-${sessionId}`);
                if (statusDiv) {
                    statusDiv.innerHTML = 'üì§ Offer sent, waiting for answer...';
                }
                
                monitoringConnections.set(sessionId, peerConnection);
                
                // Update card style
                const studentCard = document.getElementById(`student-${sessionId}`);
                if (studentCard) {
                    studentCard.classList.add('monitoring');
                }
                
                updateStats();
                
            } catch (error) {
                console.error('Error starting monitoring:', error);
                alert('Failed to start monitoring: ' + error.message);
            }
        }

        // Stop monitoring a student
        function stopMonitoring(sessionId) {
            console.log('‚èπÔ∏è Stopping monitoring for session:', sessionId);
            
            const peerConnection = monitoringConnections.get(sessionId);
            if (peerConnection) {
                peerConnection.close();
                monitoringConnections.delete(sessionId);
            }
            
            const videoContainer = document.getElementById(`video-${sessionId}`);
            if (videoContainer) {
                videoContainer.innerHTML = '<div class="screen-preview"><span>Click "Watch Screen" to monitor</span></div>';
            }
            
            const studentCard = document.getElementById(`student-${sessionId}`);
            if (studentCard) {
                studentCard.classList.remove('monitoring');
            }
            
            updateStats();
        }

        // Handle WebRTC answer
        function handleWebRTCAnswer(answer, sessionId) {
            const peerConnection = monitoringConnections.get(sessionId);
            if (peerConnection) {
                peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
            }
        }

        // Handle ICE candidate
        function handleICECandidate(candidate, sessionId) {
            const peerConnection = monitoringConnections.get(sessionId);
            if (peerConnection) {
                console.log('üßä ‚úÖ ADMIN: Adding ICE candidate from kiosk for session:', sessionId);
                peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                    .then(() => {
                        console.log('üßä ‚úÖ ADMIN: ICE candidate added successfully');
                    })
                    .catch(error => {
                        console.error('üßä ‚ùå ADMIN: Error adding ICE candidate:', error);
                    });
            } else {
                console.error('üßä ‚ùå ADMIN: No peer connection found for session:', sessionId);
            }
        }

        // Expand video to fullscreen
        function expandVideo(sessionId) {
            const videoContainer = document.getElementById(`video-${sessionId}`);
            const video = videoContainer.querySelector('video');
            
            if (!video || !video.srcObject) {
                alert('‚ùå No video stream available. Start monitoring first.');
                return;
            }
            
            const fullscreenVideo = document.getElementById('fullscreen-video');
            fullscreenVideo.srcObject = video.srcObject;
            
            document.getElementById('fullscreen-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Close fullscreen
        function closeFullscreen() {
            document.getElementById('fullscreen-modal').classList.remove('active');
            document.body.style.overflow = 'auto';
            document.getElementById('fullscreen-video').srcObject = null;
        }

        // Update statistics
        function updateStats() {
            document.getElementById('totalStudents').textContent = connectedStudents.size;
            document.getElementById('activeStudents').textContent = connectedStudents.size;
            document.getElementById('monitoringStudents').textContent = monitoringConnections.size;
        }

        // Start lab session
        function startLabSession() {
            // Show session metadata dialog
            showSessionStartDialog();
        }

        // Show session start dialog
        function showSessionStartDialog() {
            const dialog = document.createElement('div');
            dialog.id = 'session-start-dialog';
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            dialog.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%;">
                    <h2 style="color: #2c3e50; margin-bottom: 1.5rem;">üöÄ Start Lab Session</h2>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Subject Name:</label>
                        <input type="text" id="session-subject" placeholder="e.g., Data Structures Lab" 
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Handling Faculty:</label>
                        <input type="text" id="session-faculty" placeholder="e.g., Dr. Smith" 
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem;">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Year:</label>
                            <select id="session-year" style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem;">
                                <option value="1">1st Year</option>
                                <option value="2">2nd Year</option>
                                <option value="3">3rd Year</option>
                                <option value="4">4th Year</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Department:</label>
                            <select id="session-department" style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem;">
                                <option value="Computer Science">Computer Science</option>
                                <option value="Information Technology">Information Technology</option>
                                <option value="Electronics">Electronics</option>
                                <option value="Mechanical">Mechanical</option>
                                <option value="Civil">Civil</option>
                                <option value="Electrical">Electrical</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Section:</label>
                            <select id="session-section" style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem;">
                                <option value="A">Section A</option>
                                <option value="B">Section B</option>
                                <option value="C">Section C</option>
                                <option value="None">No Section</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Number of Periods (50 min each):</label>
                        <select id="session-periods" style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem;">
                            <option value="1">1 Period (50 minutes)</option>
                            <option value="2">2 Periods (100 minutes)</option>
                            <option value="3">3 Periods (150 minutes)</option>
                            <option value="4">4 Periods (200 minutes)</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="closeSessionStartDialog()" 
                                style="padding: 0.75rem 1.5rem; border: 2px solid #6c757d; background: white; color: #6c757d; border-radius: 6px; cursor: pointer;">
                            Cancel
                        </button>
                        <button onclick="confirmStartSession()" 
                                style="padding: 0.75rem 1.5rem; border: none; background: #28a745; color: white; border-radius: 6px; cursor: pointer;">
                            Start Session
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            document.getElementById('session-subject').focus();
        }

        // Close session start dialog
        function closeSessionStartDialog() {
            const dialog = document.getElementById('session-start-dialog');
            if (dialog) {
                dialog.remove();
            }
        }

        // Confirm start session
        function confirmStartSession() {
            const subject = document.getElementById('session-subject').value.trim();
            const faculty = document.getElementById('session-faculty').value.trim();
            const year = parseInt(document.getElementById('session-year').value);
            const department = document.getElementById('session-department').value;
            const section = document.getElementById('session-section').value;
            const periods = parseInt(document.getElementById('session-periods').value);
            
            if (!subject || !faculty) {
                alert('‚ùå Please fill in all required fields.');
                return;
            }
            
            // Start the lab session with metadata
            startLabSessionWithMetadata(subject, faculty, year, department, section, periods);
            closeSessionStartDialog();
        }

        // Start lab session with metadata
        function startLabSessionWithMetadata(subject, faculty, year, department, section, periods) {
            const sessionData = {
                subject,
                faculty,
                year,
                department,
                section,
                periods,
                startTime: new Date(),
                expectedDuration: periods * 50 // minutes
            };
            
            // Send to server
            fetch('/api/start-lab-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(sessionData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    sessionActive = true;
                    currentLabSession = data.session;
                    document.getElementById('startSessionBtn').disabled = true;
                    document.getElementById('endSessionBtn').disabled = false;
                    
                    // Calculate session end time
                    sessionEndTime = new Date(Date.now() + (periods * 50 * 60 * 1000)); // periods * 50 minutes * 60 seconds * 1000 ms
                    
                    // Update UI to show session info
                    updateSessionInfo(data.session);
                    
                    // Start session timer
                    startSessionTimer();
                    
                    console.log('üöÄ Lab session started with metadata:', data.session);
                    alert(`‚úÖ Lab session started successfully!\n\nSubject: ${data.session.subject}\nFaculty: ${data.session.faculty}\nDuration: ${periods} periods (${periods * 50} minutes)\n\nSession will end at: ${sessionEndTime.toLocaleTimeString()}`);
                } else {
                    alert('‚ùå Failed to start session: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error starting session:', error);
                alert('‚ùå Error starting session. Please try again.');
            });
        }

        // Start session timer
        function startSessionTimer() {
            if (sessionTimer) {
                clearInterval(sessionTimer);
            }
            
            sessionTimer = setInterval(() => {
                if (!sessionActive || !sessionEndTime) {
                    clearInterval(sessionTimer);
                    return;
                }
                
                const now = new Date();
                const timeLeft = sessionEndTime - now;
                
                if (timeLeft <= 0) {
                    // Session time is up
                    clearInterval(sessionTimer);
                    showSessionEndReminder();
                } else {
                    // Update remaining time display
                    updateRemainingTime(timeLeft);
                }
            }, 1000); // Update every second
        }

        // Show session end reminder
        function showSessionEndReminder() {
            if (sessionActive && currentLabSession) {
                const reminder = confirm(
                    `‚è∞ Session Time Complete!\n\n` +
                    `Subject: ${currentLabSession.subject}\n` +
                    `Duration: ${currentLabSession.periods} periods completed\n\n` +
                    `Please export the CSV file now before ending the session.\n\n` +
                    `Click OK to export CSV, or Cancel to end session without export.`
                );
                
                if (reminder) {
                    exportSessionData();
                } else {
                    if (confirm('Are you sure you want to end the session without exporting data?')) {
                        endLabSession();
                    }
                }
            }
        }

        // Update remaining time display
        function updateRemainingTime(timeLeft) {
            const minutes = Math.floor(timeLeft / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            // Update the session info with remaining time
            const durationElement = document.getElementById('current-duration');
            if (durationElement && currentLabSession) {
                durationElement.innerHTML = `${currentLabSession.periods} periods (${currentLabSession.expectedDuration} min) - <span style="color: #e74c3c;">Time left: ${minutes}:${seconds.toString().padStart(2, '0')}</span>`;
            }
        }

        // Update session info display
        function updateSessionInfo(sessionData) {
            document.getElementById('session-info').style.display = 'block';
            document.getElementById('current-subject').textContent = sessionData.subject;
            document.getElementById('current-faculty').textContent = sessionData.faculty;
            document.getElementById('current-year').textContent = `${sessionData.year}${sessionData.year === 1 ? 'st' : sessionData.year === 2 ? 'nd' : sessionData.year === 3 ? 'rd' : 'th'} Year`;
            document.getElementById('current-department').textContent = sessionData.department;
            document.getElementById('current-section').textContent = sessionData.section === 'None' ? 'No Section' : `Section ${sessionData.section}`;
            document.getElementById('current-duration').textContent = `${sessionData.periods} periods (${sessionData.expectedDuration} min)`;
            document.getElementById('current-start-time').textContent = new Date(sessionData.startTime).toLocaleTimeString();
        }

        // Hide session info display
        function hideSessionInfo() {
            document.getElementById('session-info').style.display = 'none';
        }

        // End lab session
        function endLabSession() {
            if (!currentLabSession) {
                alert('‚ùå No active session to end.');
                return;
            }

            if (confirm('‚ö†Ô∏è Are you sure you want to end the current lab session?\n\nThis will:\n‚Ä¢ Stop all screen monitoring\n‚Ä¢ Clear all session data\n‚Ä¢ Prepare for the next session')) {
                // Send end session request to server
                fetch('/api/end-lab-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sessionId: currentLabSession._id })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        sessionActive = false;
                        currentLabSession = null;
                        sessionEndTime = null;
                        
                        // Clear session timer
                        if (sessionTimer) {
                            clearInterval(sessionTimer);
                            sessionTimer = null;
                        }
                        
                        document.getElementById('startSessionBtn').disabled = false;
                        document.getElementById('endSessionBtn').disabled = true;
                        
                        // Stop all monitoring
                        monitoringConnections.forEach((pc, sessionId) => {
                            stopMonitoring(sessionId);
                        });
                        
                        // Clear students grid
                        document.getElementById('studentsGrid').innerHTML = '<div class="no-students">üì± No students connected. Students need to login via kiosk first.</div>';
                        connectedStudents.clear();
                        updateStats();
                        
                        // Hide session info
                        hideSessionInfo();
                        
                        console.log('üõë Lab session ended and data cleared');
                        alert('‚úÖ Lab session ended successfully!\n\nAll session data has been cleared.\nReady for the next session.');
                    } else {
                        alert('‚ùå Failed to end session: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error ending session:', error);
                    alert('‚ùå Error ending session. Please try again.');
                });
            }
        }

        // Refresh student list
        function refreshStudentList() {
            console.log('üîÑ Refreshing student list...');
            loadActiveStudents();
        }

        // Export session data to CSV
        function exportSessionData() {
            console.log('üìä Exporting session data...');
            
            if (!currentLabSession) {
                alert('‚ùå No active lab session to export.');
                return;
            }
            
            // Fetch complete session data from server
            fetch(`/api/export-session-data/${currentLabSession._id}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('üìä Export data received:', data);
                    console.log('üìä Session data:', data.sessionData);
                    console.log('üìä Student records:', data.studentRecords);
                    generateCSVFile(data.sessionData, data.studentRecords);
                } else {
                    alert('‚ùå Failed to export session data: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error exporting session data:', error);
                alert('‚ùå Error exporting session data. Please try again.');
            });
        }

        // Generate CSV file from session data
        function generateCSVFile(sessionData, studentRecords) {
            const csvData = [];
            
            // Add session header information
            csvData.push(`Lab Session Report`);
            csvData.push(`Subject: ${sessionData.subject}`);
            csvData.push(`Faculty: ${sessionData.faculty}`);
            csvData.push(`Year: ${sessionData.year}${sessionData.year === 1 ? 'st' : sessionData.year === 2 ? 'nd' : sessionData.year === 3 ? 'rd' : 'th'} Year`);
            csvData.push(`Department: ${sessionData.department}`);
            csvData.push(`Section: ${sessionData.section === 'None' ? 'No Section' : 'Section ' + sessionData.section}`);
            csvData.push(`Duration: ${sessionData.periods} periods (${sessionData.expectedDuration} minutes)`);
            csvData.push(`Started: ${new Date(sessionData.startTime).toLocaleString()}`);
            csvData.push(`Generated: ${new Date().toLocaleString()}`);
            csvData.push(`Total Students: ${studentRecords.length}`);
            csvData.push(''); // Empty line
            
            // Add student data headers
            const headers = [
                'Sr. No',
                'System No',
                'Student Name', 
                'Roll Number', 
                'Login Time', 
                'Logout Time',
                'Duration (minutes)',
                'Status'
            ];
            csvData.push(headers.join(','));
            
            // Only show students who actually logged in
            studentRecords.forEach((record, index) => {
                const loginTime = new Date(record.loginTime).toLocaleString();
                const logoutTime = record.logoutTime ? new Date(record.logoutTime).toLocaleString() : 'Still Active';
                const duration = record.duration ? Math.round(record.duration / 60) : 'Ongoing';
                
                const row = [
                    index + 1,
                    `"${record.systemNumber || '-'}"`,
                    `"${record.studentName || '-'}"`,
                    `"${record.studentId || '-'}"`,
                    `"${loginTime}"`,
                    `"${logoutTime}"`,
                    `"${duration}"`,
                    `"${record.status === 'active' ? 'Present' : 'Completed'}"`
                ];
                csvData.push(row.join(','));
            });
            
            // Create and download CSV file
            const csvContent = csvData.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${sessionData.subject.replace(/[^a-zA-Z0-9]/g, '_')}_${sessionData.year}${sessionData.section !== 'None' ? '_' + sessionData.section : ''}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            console.log('‚úÖ Session CSV exported successfully');
            alert(`‚úÖ Session data exported successfully!\n\nThe CSV includes ${studentRecords.length} students who logged in during this session.`);
        }

        // Debug session data
        function debugSessionData() {
            if (!currentLabSession) {
                alert('‚ùå No active lab session to debug.');
                return;
            }
            
            console.log('üîç Debugging session data...');
            
            // Fetch debug data from server
            fetch(`/api/debug-session-data/${currentLabSession._id}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('üîç Debug data received:', data.debug);
                    
                    // Show debug info in a popup
                    const debugInfo = `
Debug Information:

Lab Session ID: ${currentLabSession._id}
Lab Session Subject: ${data.debug.labSession?.subject || 'Not found'}
Lab Session Start Time: ${data.debug.labSession?.startTime || 'Not found'}

Recent Sessions (last 10):
${data.debug.recentSessions.map((s, i) => 
    `${i+1}. ${s.studentName} (${s.studentId}) - ${s.systemNumber} - ${new Date(s.loginTime).toLocaleString()}`
).join('\n')}

Active Sessions:
${data.debug.activeSessions.map((s, i) => 
    `${i+1}. ${s.studentName} (${s.studentId}) - ${s.systemNumber} - ${new Date(s.loginTime).toLocaleString()}`
).join('\n')}

Lab Session Student Records:
${data.debug.labSessionStudentRecords?.map((s, i) => 
    `${i+1}. ${s.studentName} (${s.studentId}) - ${s.systemNumber} - ${new Date(s.loginTime).toLocaleString()}`
).join('\n') || 'None found'}
                    `;
                    
                    alert(debugInfo);
                } else {
                    alert('‚ùå Failed to get debug data: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error getting debug data:', error);
                alert('‚ùå Error getting debug data. Check console for details.');
            });
        }

        // Force clear all sessions
        function forceClearSessions() {
            if (!confirm('‚ö†Ô∏è WARNING: This will clear ALL lab sessions and student data!\n\nAre you sure you want to continue?')) {
                return;
            }
            
            console.log('üßπ Force clearing all sessions...');
            
            fetch('/api/force-clear-all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ All sessions cleared successfully!\n\nYou can now start a new lab session.');
                    // Reset UI
                    currentLabSession = null;
                    sessionActive = false;
                    document.getElementById('session-info').style.display = 'none';
                    document.getElementById('startSessionBtn').disabled = false;
                    document.getElementById('endSessionBtn').disabled = true;
                    refreshStudentList();
                } else {
                    alert('‚ùå Failed to clear sessions: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error clearing sessions:', error);
                alert('‚ùå Error clearing sessions. Check console for details.');
            });
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const fullscreenModal = document.getElementById('fullscreen-modal');
                if (fullscreenModal.classList.contains('active')) {
                    closeFullscreen();
                }
            }
        });

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
        });
    </script>
</body>
</html>
