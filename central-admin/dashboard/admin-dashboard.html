<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üñ•Ô∏è Lab Management System - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .header .subtitle {
            opacity: 0.9;
            font-size: 1rem;
        }
        
        .main-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .control-panel {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .control-panel h2 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            font-size: 1.4rem;
        }
        
        .session-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .students-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .student-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .student-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 8px rgba(0,123,255,0.1);
        }
        
        .student-card.monitoring {
            border-color: #28a745;
            background: #f8fff9;
        }
        
        .student-info h3 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .student-info p {
            color: #6c757d;
            margin: 0.25rem 0;
            font-size: 0.9rem;
        }
        
        .video-container {
            width: 100%;
            height: 180px;
            background: #000;
            border-radius: 6px;
            margin: 1rem 0;
            position: relative;
            overflow: hidden;
        }
        
        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .screen-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .student-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .student-controls .btn {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }
        
        .no-students {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 3rem;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-online {
            background: #28a745;
        }
        
        .status-offline {
            background: #dc3545;
        }
        
        .fullscreen-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .fullscreen-modal.active {
            display: flex;
        }
        
        .fullscreen-content {
            position: relative;
            width: 90vw;
            height: 90vh;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .fullscreen-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .close-fullscreen {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 11;
        }
        
        .close-fullscreen:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Shutdown button styles */
        .btn-shutdown {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }
        
        .btn-shutdown:hover {
            background: #c82333;
            transform: scale(1.05);
        }
        
        .btn-expand {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            margin-right: 0.5rem;
        }
        
        .btn-expand:hover {
            background: #0056b3;
            transform: scale(1.05);
        }
        
        .student-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }
        
        .connection-status {
            font-size: 0.85rem;
            color: #6c757d;
            flex: 1;
            text-align: right;
        }
        
        /* Toast notification animations */
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üñ•Ô∏è Lab Management System</h1>
        <p class="subtitle">Real-time Student Monitoring & Session Management</p>
    </div>

    <div class="main-container">
        <!-- Control Panel -->
        <div class="control-panel">
            <h2>üìä Session Control</h2>
            
            <div class="session-controls">
                <button class="btn btn-success" id="startSessionBtn" onclick="startLabSession()">
                    üöÄ Start Lab Session
                </button>
                <button class="btn btn-danger" id="endSessionBtn" onclick="endLabSession()" disabled>
                    üõë End Lab Session
                </button>
                <button class="btn btn-primary" onclick="refreshStudentList()">
                    üîÑ Refresh Students
                </button>
                <button class="btn btn-secondary" onclick="debugSessionData()" style="background: #ffc107; color: #000;">
                    üîç Debug Data
                </button>
                <button class="btn btn-warning" onclick="forceClearSessions()" style="background: #dc3545; color: white;">
                    üßπ Force Clear All
                </button>
                <button class="btn btn-danger" onclick="shutdownAllSystems()" style="background: #fd7e14; color: white; font-weight: bold;">
                    ‚ö†Ô∏è Shutdown All Lab Systems
                </button>
            </div>

            <!-- Session Info -->
            <div id="session-info" style="display: none; background: #e8f5e8; border: 2px solid #28a745; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <h3 style="color: #155724; margin-bottom: 0.5rem;">üìö Current Lab Session</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <div><strong>Subject:</strong> <span id="current-subject">-</span></div>
                    <div><strong>Faculty:</strong> <span id="current-faculty">-</span></div>
                    <div><strong>Year:</strong> <span id="current-year">-</span></div>
                    <div><strong>Department:</strong> <span id="current-department">-</span></div>
                    <div><strong>Section:</strong> <span id="current-section">-</span></div>
                    <div><strong>Duration:</strong> <span id="current-duration">-</span></div>
                    <div><strong>Started:</strong> <span id="current-start-time">-</span></div>
                </div>
                
                <!-- Duration Control Panel -->
                <div style="background: white; border-radius: 6px; padding: 1rem; border: 2px solid #20c997;">
                    <h4 style="color: #20c997; margin-bottom: 0.75rem; font-size: 1rem;">‚è±Ô∏è Adjust Session Duration</h4>
                    
                    <!-- Quick Adjust (50 min per period) -->
                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                        <button onclick="adjustSessionDuration(-1)" class="btn btn-warning" style="padding: 0.5rem 1rem;">
                            ‚ûñ Remove 1 Period (50 min)
                        </button>
                        <div style="font-weight: 600; color: #2c3e50; padding: 0.5rem 1rem; background: #f8f9fa; border-radius: 6px;">
                            <span id="current-periods-display">-</span> Periods (<span id="current-minutes-display">-</span> min)
                        </div>
                        <button onclick="adjustSessionDuration(1)" class="btn btn-success" style="padding: 0.5rem 1rem;">
                            ‚ûï Add 1 Period (50 min)
                        </button>
                    </div>
                    
                    <!-- Custom Time Adjustment -->
                    <div style="border-top: 1px solid #dee2e6; padding-top: 1rem;">
                        <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 0.5rem;">Custom Time Adjustment:</label>
                        <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                            <button onclick="adjustSessionByMinutes('decrease')" class="btn btn-warning" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">
                                ‚ûñ Decrease
                            </button>
                            <input type="number" id="custom-time-input" min="5" max="100" step="5" value="10" 
                                   style="width: 80px; padding: 0.4rem; border: 2px solid #ced4da; border-radius: 4px; text-align: center; font-weight: 600;">
                            <span style="color: #6c757d; font-weight: 600;">minutes</span>
                            <button onclick="adjustSessionByMinutes('increase')" class="btn btn-success" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">
                                ‚ûï Increase
                            </button>
                        </div>
                    </div>
                    
                    <small style="color: #6c757d; display: block; margin-top: 0.75rem;">üí° Quick: Use ¬±1 period (50 min) | Custom: Choose your own time increment</small>
                </div>
            </div>

            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalStudents">0</div>
                    <div class="stat-label">Total Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeStudents">0</div>
                    <div class="stat-label">Active Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="monitoringStudents">0</div>
                    <div class="stat-label">Being Monitored</div>
                </div>
            </div>
        </div>

        <!-- Students Section -->
        <div class="students-section">
            <h2>üë• Active Students</h2>
            <div id="studentsGrid" class="students-grid">
                <div class="no-students">
                    üì± No students connected. Students need to login via kiosk first.
                </div>
            </div>
        </div>

        <!-- Report Schedule Settings Section -->
        <div class="control-panel" style="margin-top: 2rem;">
            <h2>üìÖ Automatic Report Schedule</h2>
            <p style="color: #6c757d; margin-bottom: 1.5rem;">Configure automatic daily report generation times (up to 2 schedules per day). Reports will download to your browser automatically at the scheduled times.</p>
            
            <div style="background: #f8f9fa; border-radius: 8px; padding: 1.5rem;">
                <div style="margin-bottom: 2rem;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #2c3e50;">
                            <strong>Lab ID:</strong>
                        </label>
                        <select id="scheduleLabId" style="padding: 10px; width: 100%; max-width: 300px; border-radius: 6px; border: 1px solid #ced4da; font-size: 1rem;">
                            <option value="CC1">CC1 - Computer Lab 1</option>
                            <option value="CC2">CC2 - Computer Lab 2</option>
                            <option value="LAB-01">LAB-01 - General Lab</option>
                        </select>
                    </div>
                </div>
                
                <!-- Schedule 1 -->
                <div style="background: white; border: 2px solid #28a745; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #28a745; margin-bottom: 1rem;">üïê Schedule 1 (Morning/Afternoon)</h4>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; align-items: end;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #2c3e50;">
                                <strong>Report Generation Time (24-hour):</strong>
                            </label>
                            <input type="time" id="scheduleTime1" style="padding: 10px; width: 100%; border-radius: 6px; border: 1px solid #ced4da; font-size: 1rem;" value="13:00">
                        </div>
                        <div>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="scheduleEnabled1" checked style="margin-right: 10px; width: 20px; height: 20px; cursor: pointer;">
                                <span style="font-weight: 600; color: #2c3e50;">Enable</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Schedule 2 -->
                <div style="background: white; border: 2px solid #007bff; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                    <h4 style="color: #007bff; margin-bottom: 1rem;">üïï Schedule 2 (Evening)</h4>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; align-items: end;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #2c3e50;">
                                <strong>Report Generation Time (24-hour):</strong>
                            </label>
                            <input type="time" id="scheduleTime2" style="padding: 10px; width: 100%; border-radius: 6px; border: 1px solid #ced4da; font-size: 1rem;" value="18:00">
                        </div>
                        <div>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="scheduleEnabled2" checked style="margin-right: 10px; width: 20px; height: 20px; cursor: pointer;">
                                <span style="font-weight: 600; color: #2c3e50;">Enable</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
                    <button onclick="saveSchedule()" class="btn btn-success">
                        üíæ Save Schedule
                    </button>
                    
                    <button onclick="loadSchedule()" class="btn btn-secondary">
                        üîÑ Load Current Schedule
                    </button>
                    
                    <button onclick="generateReportNow()" class="btn btn-primary">
                        üìä Generate Report Now (Test)
                    </button>
                </div>
                
                <div id="scheduleStatus" style="margin-top: 15px; padding: 12px; border-radius: 8px; display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Fullscreen Modal -->
    <div id="fullscreen-modal" class="fullscreen-modal">
        <button class="close-fullscreen" onclick="closeFullscreen()">√ó</button>
        <button id="snapshotBtn" onclick="takeSnapshot()" style="display:none; position:absolute; top:20px; right:80px; z-index:12; background:#28a745; color:white; border:none; padding:0.75rem 1.5rem; border-radius:6px; cursor:pointer; font-size:1rem; font-weight:600; box-shadow:0 4px 6px rgba(0,0,0,0.3);">
            üì∏ Take Snapshot
        </button>
        <div class="fullscreen-content">
            <video id="fullscreen-video" class="fullscreen-video" autoplay muted></video>
            <div id="fullscreen-student-info" style="position:absolute; top:20px; left:20px; background:rgba(0,0,0,0.7); color:white; padding:1rem; border-radius:8px; font-size:0.9rem; z-index:11;">
                <strong id="fullscreen-student-name">-</strong><br>
                <small id="fullscreen-student-details">-</small>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Global variables
        let socket;
        let connectedStudents = new Map();
        let monitoringConnections = new Map();
        let sessionActive = false;
        let currentLabSession = null;
        let sessionTimer = null;
        let sessionEndTime = null;
        let sessionExported = false; // Track if CSV has been exported
        let screenReadySessions = new Set(); // Track which kiosk screens are ready
        let autoRefreshInterval = null; // Periodic refresh timer

        // Initialize socket connection
        function initializeSocket() {
            console.log('üöÄ Admin dashboard loading...');
            
            socket = io('http://192.168.29.212:7401');
            
            socket.on('connect', () => {
                console.log('‚úÖ Admin dashboard connected:', socket.id);
                socket.emit('register-admin');
                loadActiveStudents();
                
                // Start automatic refresh every 3 seconds to detect new logins
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                }
                autoRefreshInterval = setInterval(() => {
                    console.log('üîÑ Auto-refreshing sessions...');
                    loadActiveStudents();
                }, 3000);
                console.log('‚úÖ Auto-refresh started (every 3 seconds)');
            });
            
            socket.on('disconnect', () => {
                console.log('‚ùå Admin dashboard disconnected');
                
                // Stop auto-refresh when disconnected
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                    console.log('üõë Auto-refresh stopped');
                }
            });
            
            socket.on('connect_error', (error) => {
                console.error('‚ùå Connection error:', error);
            });
            
            // Listen for student events
            socket.on('session-created', (sessionData) => {
                console.log('üì± New session created:', sessionData);
                addStudentToGrid(sessionData);
                updateStats();
            });
            
            socket.on('session-ended', (sessionData) => {
                console.log('üì± Session ended:', sessionData);
                removeStudentFromGrid(sessionData.sessionId);
                // Clear screen ready status for this session
                screenReadySessions.delete(sessionData.sessionId);
                console.log('üßπ Cleared screen ready status for:', sessionData.sessionId);
                updateStats();
            });
            
            socket.on('active-sessions', (sessions) => {
                console.log('üìã Active sessions received:', sessions);
                displayActiveSessions(sessions);
            });
            
            // Listen for lab session ended event
            socket.on('lab-session-ended', (data) => {
                console.log('üõë Lab session ended:', data);
                // Force refresh to clear all students
                setTimeout(() => {
                    loadActiveStudents();
                }, 500);
            });
            
            // Listen for kiosk screen ready event
            socket.on('kiosk-screen-ready', (data) => {
                console.log('\n==============================================');
                console.log('üéâ ADMIN: KIOSK SCREEN READY EVENT RECEIVED');
                console.log('Session ID:', data.sessionId);
                console.log('Has Video:', data.hasVideo);
                console.log('==============================================\n');
                
                screenReadySessions.add(data.sessionId);
                
                // Wait for grid element to be ready, then start monitoring immediately
                const tryStartMonitoring = (attempt = 0) => {
                    const videoContainer = document.getElementById(`video-${data.sessionId}`);
                    
                    if (videoContainer && connectedStudents.has(data.sessionId)) {
                        if (!monitoringConnections.has(data.sessionId)) {
                            console.log(`üé• ‚ö° IMMEDIATE START - Screen ready (attempt ${attempt + 1}):`, data.sessionId);
                            startMonitoring(data.sessionId);
                        } else {
                            console.log('‚úÖ Monitoring already active for:', data.sessionId);
                        }
                    } else if (attempt < 10) {
                        // Video container not ready yet, wait 200ms and retry (up to 2 seconds)
                        console.log(`‚è≥ Waiting for video container (attempt ${attempt + 1})...`);
                        setTimeout(() => tryStartMonitoring(attempt + 1), 200);
                    } else {
                        console.error('‚ùå Video container never appeared for session:', data.sessionId);
                    }
                };
                
                tryStartMonitoring();
            });
            
            // WebRTC signaling
            socket.on('webrtc-answer', ({ answer, sessionId }) => {
                console.log('üìπ WebRTC answer received for session:', sessionId);
                handleWebRTCAnswer(answer, sessionId);
            });
            
            socket.on('webrtc-ice-candidate', ({ candidate, sessionId }) => {
                console.log('üßä ‚úÖ ADMIN RECEIVED ICE CANDIDATE from kiosk for session:', sessionId, candidate.type);
                handleICECandidate(candidate, sessionId);
            });
            
            // Listen for shutdown events
            socket.on('shutdown-error', ({ sessionId, error }) => {
                console.error('‚ùå Shutdown error for session:', sessionId, error);
                showNotification(`Shutdown failed: ${error}`, 'danger');
            });

            socket.on('shutdown-all-complete', ({ labId, count }) => {
                console.log(`‚úÖ Shutdown complete for ${count} systems in lab ${labId}`);
                showNotification(`Successfully sent shutdown to ${count} systems`, 'success');
            });

            // Listen for scheduled report ready events
            socket.on('scheduled-report-ready', ({ labId, filename, csvContent, count, timestamp }) => {
                console.log('üìä ‚úÖ SCHEDULED REPORT READY:', { labId, filename, count });
                console.log('üì• Auto-downloading report to browser...');
                
                // Create blob from CSV content
                const blob = new Blob([csvContent], { type: 'text/csv' });
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                console.log('‚úÖ Report auto-downloaded:', filename);
                
                // Show notification
                showNotification(`üìä Report auto-downloaded: ${filename} (${count} sessions)`, 'success');
            });
        }

        // Load active students
        function loadActiveStudents() {
            if (socket && socket.connected) {
                socket.emit('get-active-sessions');
            }
        }

        // Display active sessions
        function displayActiveSessions(sessions) {
            const grid = document.getElementById('studentsGrid');
            
            if (!sessions || sessions.length === 0) {
                // Only clear if we don't have any existing connections
                if (connectedStudents.size === 0) {
                    grid.innerHTML = '<div class="no-students">üì± No students connected. Students need to login via kiosk first.</div>';
                }
                updateStats();
                return;
            }
            
            // Don't rebuild grid if sessions haven't changed AND grid is not empty
            const currentSessionIds = new Set(sessions.map(s => s._id || s.sessionId || s.id));
            const existingSessionIds = new Set(connectedStudents.keys());
            
            // Check if sessions are the same
            const sessionsChanged = currentSessionIds.size !== existingSessionIds.size ||
                                   ![...currentSessionIds].every(id => existingSessionIds.has(id));
            
            // Check if grid has content
            const gridHasStudents = grid.children.length > 0 && !grid.querySelector('.no-students');
            
            if (!sessionsChanged && gridHasStudents) {
                console.log('‚úÖ Sessions unchanged and grid populated, skipping rebuild');
                
                // CRITICAL FIX: Even if grid unchanged, ensure monitoring is active for all sessions
                setTimeout(() => {
                    sessions.forEach(session => {
                        const sessionId = session._id || session.sessionId || session.id;
                        if (sessionId && !monitoringConnections.has(sessionId)) {
                            console.log('üé• Grid skipped but monitoring missing - starting for:', sessionId);
                            startMonitoring(sessionId);
                        }
                    });
                }, 1000);
                
                updateStats();
                return;
            }
            
            if (!sessionsChanged && !gridHasStudents) {
                console.log('üîÑ Sessions unchanged but grid is EMPTY - rebuilding...');
            } else if (sessionsChanged) {
                console.log('üîÑ Sessions changed, rebuilding grid...');
            }
            
            // Preserve existing monitoring connections
            const existingConnections = new Map(monitoringConnections);
            
            grid.innerHTML = '';
            connectedStudents.clear();
            
            console.log('üé• DISPLAYING sessions and preserving existing connections...');
            
            sessions.forEach(session => {
                const sessionId = session._id || session.sessionId || session.id;
                if (sessionId) {
                    connectedStudents.set(sessionId, session);
                    
                    // Create the student card first
                    addStudentToGrid(session);
                    
                    // AUTO-START monitoring for this session
                    setTimeout(() => {
                        // Check if we have an existing connection AND it's actually connected
                        if (existingConnections.has(sessionId)) {
                            const existingPC = existingConnections.get(sessionId);
                            const isConnected = existingPC && 
                                              (existingPC.connectionState === 'connected' || 
                                               existingPC.iceConnectionState === 'connected');
                            
                            if (isConnected) {
                                console.log('üîó PRESERVING active connection for session:', sessionId);
                                monitoringConnections.set(sessionId, existingPC);
                                const videoContainer = document.getElementById(`video-${sessionId}`);
                                if (videoContainer) {
                                    const existingVideo = videoContainer.querySelector('video');
                                    if (existingVideo && existingVideo.srcObject) {
                                        console.log('‚úÖ Video stream still active');
                                    }
                                }
                            } else {
                                console.log('‚ùå Existing connection FAILED - starting fresh for:', sessionId);
                                // Close the failed connection
                                if (existingPC) {
                                    existingPC.close();
                                }
                                // Start fresh
                                setTimeout(() => {
                                    if (!monitoringConnections.has(sessionId)) {
                                        startMonitoring(sessionId);
                                    }
                                }, 5000);
                            }
                        } else {
                            // No existing connection - start fresh
                            setTimeout(() => {
                                if (!monitoringConnections.has(sessionId)) {
                                    console.log('üé• AUTO-STARTING fresh for:', sessionId);
                                    startMonitoring(sessionId);
                                }
                            }, 5000);
                        }
                    }, 1000); // Small delay to ensure DOM is ready
                }
            });
            
            updateStats();
        }

        // Add student to grid
        function addStudentToGrid(sessionData) {
            const sessionId = sessionData._id || sessionData.sessionId || sessionData.id;
            
            if (!sessionId) {
                console.error('‚ùå No valid session ID found:', sessionData);
                return;
            }
            
            // Remove existing card if present
            const existingCard = document.getElementById(`student-${sessionId}`);
            if (existingCard) {
                existingCard.remove();
            }
            
            const studentCard = document.createElement('div');
            studentCard.className = 'student-card';
            studentCard.id = `student-${sessionId}`;
            
            const loginTime = new Date(sessionData.loginTime).toLocaleTimeString();
            
            studentCard.innerHTML = `
                <div class="student-info">
                    <div class="student-name">üë§ ${sessionData.studentName}</div>
                    <div class="student-details">
                        <div><strong>ID:</strong> ${sessionData.studentId}</div>
                        <div><strong>System:</strong> ${sessionData.systemNumber}</div>
                        <div><strong>Login:</strong> ${loginTime}</div>
                    </div>
                </div>
                <div class="video-container" id="video-${sessionId}">
                    <div class="no-video">üîÑ Auto-connecting to screen...</div>
                </div>
                <div class="student-actions">
                    <button onclick="expandVideo('${sessionId}')" class="btn-expand">üîç Expand</button>
                    <button onclick="shutdownSystem('${sessionId}', '${sessionData.systemNumber}')" class="btn-shutdown" title="Shutdown this system">üîå Shutdown</button>
                    <div class="connection-status" id="status-${sessionId}">üîÑ Auto-connecting...</div>
                </div>
            `;
            
            const grid = document.getElementById('studentsGrid');
            if (grid.querySelector('.no-students')) {
                grid.innerHTML = '';
            }
            grid.appendChild(studentCard);
            
            connectedStudents.set(sessionId, sessionData);
            
            // Try to start monitoring after a delay (kiosk should be ready by then)
            console.log('‚è≥ Student added to grid, will auto-start monitoring in 5 seconds:', sessionId);
            setTimeout(() => {
                if (!monitoringConnections.has(sessionId)) {
                    console.log('üé• AUTO-STARTING monitoring after delay for:', sessionId);
                    startMonitoring(sessionId);
                } else {
                    console.log('‚úÖ Monitoring already started for:', sessionId);
                }
            }, 5000); // 5 second delay to ensure kiosk screen is ready
        }

        // Remove student from grid
        function removeStudentFromGrid(sessionId) {
            const studentCard = document.getElementById(`student-${sessionId}`);
            if (studentCard) {
                studentCard.remove();
            }
            
            connectedStudents.delete(sessionId);
            
            // Clean up monitoring connection
            if (monitoringConnections.has(sessionId)) {
                monitoringConnections.get(sessionId).close();
                monitoringConnections.delete(sessionId);
            }
            
            // Show no students message if grid is empty
            const grid = document.getElementById('studentsGrid');
            if (grid.children.length === 0) {
                grid.innerHTML = '<div class="no-students">üì± No students connected. Students need to login via kiosk first.</div>';
            }
        }

        // Start monitoring a student
        async function startMonitoring(sessionId) {
            try {
                console.log('üìπ Starting monitoring for session:', sessionId);
                
                const videoContainer = document.getElementById(`video-${sessionId}`);
                if (!videoContainer) {
                    throw new Error('Video container not found');
                }
                
                // Create video element
                const video = document.createElement('video');
                video.autoplay = true;
                video.muted = true;
                video.style.width = '100%';
                video.style.height = '100%';
                video.style.objectFit = 'cover';
                
                videoContainer.innerHTML = '';
                videoContainer.appendChild(video);
                
                // Create WebRTC peer connection with multiple STUN servers
                const peerConnection = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        { urls: 'stun:stun3.l.google.com:19302' },
                        { urls: 'stun:stun4.l.google.com:19302' }
                    ],
                    iceCandidatePoolSize: 10
                });
                
                console.log('üîó Created peer connection with enhanced ICE configuration');
                
                // Handle remote stream
                let trackReceived = false;
                peerConnection.ontrack = (event) => {
                    trackReceived = true;
                    console.log('üì∫ ‚úÖ RECEIVED REMOTE STREAM for session:', sessionId, event);
                    console.log('üì∫ Stream tracks:', event.streams[0].getTracks());
                    video.srcObject = event.streams[0];
                    
                    // Add video event listeners for debugging
                    video.onloadedmetadata = () => {
                        console.log('‚úÖ Video metadata loaded for session:', sessionId);
                    };
                    
                    video.onplay = () => {
                        console.log('‚ñ∂Ô∏è Video started playing for session:', sessionId);
                    };
                    
                    video.onerror = (error) => {
                        console.error('‚ùå Video error for session:', sessionId, error);
                    };
                };
                
                // Check if track is received within 10 seconds
                setTimeout(() => {
                    if (!trackReceived) {
                        console.error('‚ùå ‚ùå NO VIDEO TRACK RECEIVED within 10 seconds for session:', sessionId);
                        console.error('‚ùå This means the kiosk is not sending video tracks properly');
                        console.error('‚ùå Connection state:', peerConnection.connectionState);
                        console.error('‚ùå ICE state:', peerConnection.iceConnectionState);
                    }
                }, 10000);
                
                // Handle ICE candidates
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log('üßä ‚úÖ ADMIN SENDING ICE CANDIDATE for session:', sessionId, event.candidate.type);
                        socket.emit('webrtc-ice-candidate', {
                            candidate: event.candidate,
                            sessionId: sessionId
                        });
                        console.log('üßä ‚úÖ Admin ICE candidate sent to server');
                    } else {
                        console.log('üßä ‚úÖ Admin ICE gathering complete for session:', sessionId);
                    }
                };
                
                // Monitor connection state
                peerConnection.onconnectionstatechange = () => {
                    console.log('üîÑ Connection state changed for session:', sessionId, peerConnection.connectionState);
                    const statusDiv = document.getElementById(`status-${sessionId}`);
                    
                    if (peerConnection.connectionState === 'connected') {
                        console.log('‚úÖ ‚úÖ WebRTC CONNECTED for session:', sessionId, '- Video should be flowing now!');
                        if (statusDiv) {
                            statusDiv.innerHTML = '‚úÖ Connected';
                            statusDiv.style.color = '#28a745';
                        }
                    } else if (peerConnection.connectionState === 'failed') {
                        console.error('‚ùå WebRTC connection failed for session:', sessionId);
                        if (statusDiv) {
                            statusDiv.innerHTML = '‚ùå Connection failed';
                            statusDiv.style.color = '#dc3545';
                        }
                    } else if (peerConnection.connectionState === 'connecting') {
                        if (statusDiv) {
                            statusDiv.innerHTML = 'üîó Connecting...';
                        }
                    }
                };
                
                // Monitor ICE connection state
                peerConnection.oniceconnectionstatechange = () => {
                    console.log('üßä ICE connection state changed for session:', sessionId, peerConnection.iceConnectionState);
                    if (peerConnection.iceConnectionState === 'connected') {
                        console.log('‚úÖ ICE CONNECTED for session:', sessionId);
                    } else if (peerConnection.iceConnectionState === 'failed') {
                        console.error('‚ùå ICE connection FAILED for session:', sessionId);
                        const statusDiv = document.getElementById(`status-${sessionId}`);
                        if (statusDiv) {
                            statusDiv.innerHTML = '‚ùå ICE failed - Check network';
                            statusDiv.style.color = '#dc3545';
                        }
                    }
                };
                
                // Create offer with specific constraints to ensure media
                const offer = await peerConnection.createOffer({
                    offerToReceiveVideo: true,
                    offerToReceiveAudio: false
                });
                await peerConnection.setLocalDescription(offer);
                console.log('‚úÖ ADMIN: Offer created and local description set');
                
                // Send offer to kiosk
                console.log('üì§ ADMIN: Sending offer to kiosk for session:', sessionId);
                socket.emit('admin-offer', {
                    offer: offer,
                    sessionId: sessionId,
                    adminSocketId: socket.id
                });
                console.log('‚úÖ ADMIN: Offer sent to kiosk');
                
                // Update status
                const statusDiv = document.getElementById(`status-${sessionId}`);
                if (statusDiv) {
                    statusDiv.innerHTML = 'üì§ Offer sent, waiting for answer...';
                }
                
                monitoringConnections.set(sessionId, peerConnection);
                
                // Update card style
                const studentCard = document.getElementById(`student-${sessionId}`);
                if (studentCard) {
                    studentCard.classList.add('monitoring');
                }
                
                updateStats();
                
            } catch (error) {
                console.error('Error starting monitoring:', error);
                alert('Failed to start monitoring: ' + error.message);
            }
        }

        // Stop monitoring a student
        function stopMonitoring(sessionId) {
            console.log('‚èπÔ∏è Stopping monitoring for session:', sessionId);
            
            const peerConnection = monitoringConnections.get(sessionId);
            if (peerConnection) {
                peerConnection.close();
                monitoringConnections.delete(sessionId);
            }
            
            const videoContainer = document.getElementById(`video-${sessionId}`);
            if (videoContainer) {
                videoContainer.innerHTML = '<div class="screen-preview"><span>Click "Watch Screen" to monitor</span></div>';
            }
            
            const studentCard = document.getElementById(`student-${sessionId}`);
            if (studentCard) {
                studentCard.classList.remove('monitoring');
            }
            
            updateStats();
        }

        // Handle WebRTC answer
        async function handleWebRTCAnswer(answer, sessionId) {
            const peerConnection = monitoringConnections.get(sessionId);
            if (peerConnection) {
                console.log('‚úÖ ADMIN: Received answer from kiosk for session:', sessionId);
                try {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                    console.log('‚úÖ ADMIN: Remote description set successfully for session:', sessionId);
                    
                    const statusDiv = document.getElementById(`status-${sessionId}`);
                    if (statusDiv) {
                        statusDiv.innerHTML = 'üîó Connecting...';
                    }
                } catch (error) {
                    console.error('‚ùå ADMIN: Error setting remote description:', error);
                }
            } else {
                console.error('‚ùå ADMIN: No peer connection found for session:', sessionId);
            }
        }

        // Handle ICE candidate
        function handleICECandidate(candidate, sessionId) {
            const peerConnection = monitoringConnections.get(sessionId);
            if (peerConnection) {
                console.log('üßä ‚úÖ ADMIN: Adding ICE candidate from kiosk for session:', sessionId);
                peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                    .then(() => {
                        console.log('üßä ‚úÖ ADMIN: ICE candidate added successfully');
                    })
                    .catch(error => {
                        console.error('üßä ‚ùå ADMIN: Error adding ICE candidate:', error);
                    });
            } else {
                console.error('üßä ‚ùå ADMIN: No peer connection found for session:', sessionId);
            }
        }

        // Expand video to fullscreen
        function expandVideo(sessionId) {
            const videoContainer = document.getElementById(`video-${sessionId}`);
            const video = videoContainer.querySelector('video');
            
            if (!video || !video.srcObject) {
                alert('‚ùå No video stream available. Start monitoring first.');
                return;
            }
            
            const fullscreenVideo = document.getElementById('fullscreen-video');
            const fullscreenModal = document.getElementById('fullscreen-modal');
            const snapshotBtn = document.getElementById('snapshotBtn');
            
            // Copy stream to fullscreen video
            fullscreenVideo.srcObject = video.srcObject;
            
            // Store session ID for snapshot
            fullscreenVideo.dataset.sessionId = sessionId;
            
            // Update student info
            const studentData = connectedStudents.get(sessionId);
            if (studentData) {
                document.getElementById('fullscreen-student-name').textContent = studentData.studentName || 'Unknown Student';
                document.getElementById('fullscreen-student-details').textContent = `Roll: ${studentData.studentId} | System: ${studentData.systemNumber}`;
            }
            
            // Show snapshot button when video is playing
            fullscreenVideo.onplaying = () => {
                console.log('üì∏ Video playing - showing snapshot button');
                snapshotBtn.style.display = 'block';
            };
            
            // Hide snapshot button if video pauses or ends
            fullscreenVideo.onpause = () => {
                snapshotBtn.style.display = 'none';
            };
            
            fullscreenVideo.onerror = () => {
                snapshotBtn.style.display = 'none';
            };
            
            // Show modal
            fullscreenModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Close fullscreen
        function closeFullscreen() {
            const fullscreenModal = document.getElementById('fullscreen-modal');
            const fullscreenVideo = document.getElementById('fullscreen-video');
            const snapshotBtn = document.getElementById('snapshotBtn');
            
            fullscreenModal.classList.remove('active');
            document.body.style.overflow = 'auto';
            fullscreenVideo.srcObject = null;
            snapshotBtn.style.display = 'none';
        }
        
        // Take snapshot from fullscreen video
        function takeSnapshot() {
            console.log('üì∏ Take snapshot button clicked');
            
            const fullscreenVideo = document.getElementById('fullscreen-video');
            
            if (!fullscreenVideo || !fullscreenVideo.srcObject) {
                alert('‚ùå No video stream found to capture snapshot');
                return;
            }
            
            // Check if video has valid dimensions
            if (fullscreenVideo.videoWidth === 0 || fullscreenVideo.videoHeight === 0) {
                alert('‚ùå Video dimensions are invalid. Please wait for the video to load properly.');
                console.error('‚ùå Invalid video dimensions:', fullscreenVideo.videoWidth, fullscreenVideo.videoHeight);
                return;
            }
            
            console.log('üì∏ Creating canvas with dimensions:', fullscreenVideo.videoWidth, fullscreenVideo.videoHeight);
            
            // Create canvas
            const canvas = document.createElement('canvas');
            canvas.width = fullscreenVideo.videoWidth;
            canvas.height = fullscreenVideo.videoHeight;
            
            // Draw video frame to canvas
            const ctx = canvas.getContext('2d');
            ctx.drawImage(fullscreenVideo, 0, 0, canvas.width, canvas.height);
            
            // Get session data for filename
            const sessionId = fullscreenVideo.dataset.sessionId;
            const studentData = connectedStudents.get(sessionId);
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const filename = `snapshot_${studentData ? studentData.systemNumber : 'unknown'}_${timestamp}.png`;
            
            console.log('üì∏ Converting canvas to blob...');
            
            // Convert to blob and download
            canvas.toBlob(function(blob) {
                if (!blob) {
                    alert('‚ùå Failed to create snapshot image');
                    console.error('‚ùå Blob creation failed');
                    return;
                }
                
                console.log('‚úÖ Blob created, size:', blob.size, 'bytes');
                console.log('üì• Downloading as:', filename);
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                console.log('‚úÖ Snapshot downloaded successfully');
                showNotification(`üì∏ Snapshot captured: ${filename}`, 'info');
            }, 'image/png');
        }

        // Shutdown specific system
        function shutdownSystem(sessionId, systemNumber) {
            if (confirm(`‚ö†Ô∏è SHUTDOWN CONFIRMATION\n\nAre you sure you want to shutdown ${systemNumber}?\n\nThis will:\n- Immediately notify the student\n- Logout their session\n- Shut down their computer in 10 seconds\n\nContinue?`)) {
                console.log(`üîå Sending shutdown command for session: ${sessionId}`);
                socket.emit('shutdown-system', { sessionId });
                
                // Show feedback
                const statusElement = document.getElementById(`status-${sessionId}`);
                if (statusElement) {
                    statusElement.innerHTML = 'üîå Shutdown initiated...';
                    statusElement.style.color = '#dc3545';
                }
                
                // Show toast notification
                showNotification(`Shutdown command sent to ${systemNumber}`, 'warning');
            }
        }

        // Shutdown all systems in the lab
        function shutdownAllSystems() {
            const activeCount = connectedStudents.size;
            
            if (activeCount === 0) {
                alert('‚ùå No active systems to shutdown.');
                return;
            }
            
            if (confirm(`‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è SHUTDOWN ALL SYSTEMS ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è\n\nThis will shutdown ALL ${activeCount} active lab computers!\n\nEach student will:\n- Receive an immediate warning\n- Be logged out automatically\n- Have their computer shut down in 10 seconds\n\nThis action cannot be undone!\n\nAre you ABSOLUTELY SURE?`)) {
                const labId = 'CC1'; // Default lab ID - you can make this dynamic if needed
                console.log(`üîå Sending shutdown ALL command for lab: ${labId}`);
                socket.emit('shutdown-all-systems', { labId });
                
                // Show feedback for all students
                connectedStudents.forEach((student, sessionId) => {
                    const statusElement = document.getElementById(`status-${sessionId}`);
                    if (statusElement) {
                        statusElement.innerHTML = 'üîå Shutdown initiated...';
                        statusElement.style.color = '#dc3545';
                    }
                });
                
                // Show toast notification
                showNotification(`Shutdown command sent to ALL ${activeCount} systems`, 'danger');
            }
        }

        // Show notification toast
        function showNotification(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'danger' ? '#dc3545' : type === 'warning' ? '#fd7e14' : '#28a745'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease;
                font-weight: 500;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Remove after 4 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // Update statistics
        function updateStats() {
            document.getElementById('totalStudents').textContent = connectedStudents.size;
            document.getElementById('activeStudents').textContent = connectedStudents.size;
            document.getElementById('monitoringStudents').textContent = monitoringConnections.size;
        }

        // Start lab session
        function startLabSession() {
            // Show session metadata dialog
            showSessionStartDialog();
        }

        // Show session start dialog
        function showSessionStartDialog() {
            const dialog = document.createElement('div');
            dialog.id = 'session-start-dialog';
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            dialog.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%;">
                    <h2 style="color: #2c3e50; margin-bottom: 1.5rem;">üöÄ Start Lab Session</h2>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Subject Name:</label>
                        <input type="text" id="session-subject" placeholder="e.g., Data Structures Lab" 
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Handling Faculty:</label>
                        <input type="text" id="session-faculty" placeholder="e.g., Dr. Smith" 
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem;">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Year:</label>
                            <select id="session-year" style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem;">
                                <option value="1">1st Year</option>
                                <option value="2">2nd Year</option>
                                <option value="3">3rd Year</option>
                                <option value="4">4th Year</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Department:</label>
                            <select id="session-department" style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem;">
                                <option value="Computer Science">Computer Science</option>
                                <option value="Information Technology">Information Technology</option>
                                <option value="Electronics">Electronics</option>
                                <option value="Mechanical">Mechanical</option>
                                <option value="Civil">Civil</option>
                                <option value="Electrical">Electrical</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Section:</label>
                            <select id="session-section" style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1rem;">
                                <option value="A">Section A</option>
                                <option value="B">Section B</option>
                                <option value="C">Section C</option>
                                <option value="None">No Section</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Number of Periods (50 min each):</label>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <button onclick="decrementPeriods(); event.preventDefault();" 
                                    style="padding: 0.75rem 1.5rem; font-size: 1.5rem; font-weight: bold; border: 2px solid #6c757d; background: white; color: #6c757d; border-radius: 6px; cursor: pointer; min-width: 50px;">
                                ‚àí
                            </button>
                            <div style="flex: 1; text-align: center; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 6px; background: #f8f9fa; font-size: 1.1rem; font-weight: 600;">
                                <span id="session-periods-display">2</span> Periods 
                                (<span id="session-duration-display">100</span> minutes)
                            </div>
                            <button onclick="incrementPeriods(); event.preventDefault();" 
                                    style="padding: 0.75rem 1.5rem; font-size: 1.5rem; font-weight: bold; border: 2px solid #28a745; background: #28a745; color: white; border-radius: 6px; cursor: pointer; min-width: 50px;">
                                +
                            </button>
                        </div>
                        <input type="hidden" id="session-periods" value="2">
                        <small style="color: #6c757d; display: block; margin-top: 0.5rem;">Click +/‚àí to adjust session duration</small>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="closeSessionStartDialog()" 
                                style="padding: 0.75rem 1.5rem; border: 2px solid #6c757d; background: white; color: #6c757d; border-radius: 6px; cursor: pointer;">
                            Cancel
                        </button>
                        <button onclick="confirmStartSession()" 
                                style="padding: 0.75rem 1.5rem; border: none; background: #28a745; color: white; border-radius: 6px; cursor: pointer;">
                            Start Session
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            document.getElementById('session-subject').focus();
        }

        // Increment periods
        function incrementPeriods() {
            const periodsInput = document.getElementById('session-periods');
            const periodsDisplay = document.getElementById('session-periods-display');
            const durationDisplay = document.getElementById('session-duration-display');
            
            let currentPeriods = parseInt(periodsInput.value);
            if (currentPeriods < 6) {  // Max 6 periods (300 minutes)
                currentPeriods++;
                periodsInput.value = currentPeriods;
                periodsDisplay.textContent = currentPeriods;
                durationDisplay.textContent = currentPeriods * 50;
            }
        }

        // Decrement periods
        function decrementPeriods() {
            const periodsInput = document.getElementById('session-periods');
            const periodsDisplay = document.getElementById('session-periods-display');
            const durationDisplay = document.getElementById('session-duration-display');
            
            let currentPeriods = parseInt(periodsInput.value);
            if (currentPeriods > 1) {  // Min 1 period (50 minutes)
                currentPeriods--;
                periodsInput.value = currentPeriods;
                periodsDisplay.textContent = currentPeriods;
                durationDisplay.textContent = currentPeriods * 50;
            }
        }

        // Close session start dialog
        function closeSessionStartDialog() {
            const dialog = document.getElementById('session-start-dialog');
            if (dialog) {
                dialog.remove();
            }
        }

        // Confirm start session
        function confirmStartSession() {
            const subject = document.getElementById('session-subject').value.trim();
            const faculty = document.getElementById('session-faculty').value.trim();
            const year = parseInt(document.getElementById('session-year').value);
            const department = document.getElementById('session-department').value;
            const section = document.getElementById('session-section').value;
            const periods = parseInt(document.getElementById('session-periods').value);
            
            if (!subject || !faculty) {
                alert('‚ùå Please fill in all required fields.');
                return;
            }
            
            // Start the lab session with metadata
            startLabSessionWithMetadata(subject, faculty, year, department, section, periods);
            closeSessionStartDialog();
        }

        // Start lab session with metadata
        function startLabSessionWithMetadata(subject, faculty, year, department, section, periods) {
            const sessionData = {
                subject,
                faculty,
                year,
                department,
                section,
                periods,
                startTime: new Date(),
                expectedDuration: periods * 50 // minutes
            };
            
            // Send to server
            fetch('/api/start-lab-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(sessionData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    sessionActive = true;
                    currentLabSession = data.session;
                    sessionExported = false; // Reset export flag for new session
                    document.getElementById('startSessionBtn').disabled = true;
                    document.getElementById('endSessionBtn').disabled = false;
                    
                    // Calculate session end time
                    sessionEndTime = new Date(Date.now() + (periods * 50 * 60 * 1000)); // periods * 50 minutes * 60 seconds * 1000 ms
                    
                    // Update UI to show session info
                    updateSessionInfo(data.session);
                    
                    // Start session timer
                    startSessionTimer();
                    
                    // Preserve existing student connections - don't clear them
                    console.log('üöÄ Lab session started with metadata:', data.session);
                    console.log('üîó Preserving existing student connections...');
                    
                    // Refresh student list without clearing existing connections
                    loadActiveStudents();
                    
                    // CRITICAL FIX: Force start screen mirroring for all existing sessions
                    console.log('üé• FORCE-STARTING screen mirroring for all connected students...');
                    setTimeout(() => {
                        connectedStudents.forEach((sessionData, sessionId) => {
                            if (!monitoringConnections.has(sessionId)) {
                                console.log('üé• Force-starting monitoring for:', sessionId);
                                startMonitoring(sessionId);
                            } else {
                                console.log('‚úÖ Monitoring already active for:', sessionId);
                            }
                        });
                    }, 2000); // 2 second delay to ensure UI is ready
                    
                    alert(`‚úÖ Lab session started successfully!\n\nSubject: ${data.session.subject}\nFaculty: ${data.session.faculty}\nDuration: ${periods} periods (${periods * 50} minutes)\n\nSession will end at: ${sessionEndTime.toLocaleTimeString()}`);
                } else {
                    alert('‚ùå Failed to start session: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error starting session:', error);
                alert('‚ùå Error starting session. Please try again.');
            });
        }

        // Start session timer
        function startSessionTimer() {
            if (sessionTimer) {
                clearInterval(sessionTimer);
            }
            
            sessionTimer = setInterval(() => {
                if (!sessionActive || !sessionEndTime) {
                    clearInterval(sessionTimer);
                    return;
                }
                
                const now = new Date();
                const timeLeft = sessionEndTime - now;
                
                if (timeLeft <= 0) {
                    // Session time is up
                    clearInterval(sessionTimer);
                    showSessionEndReminder();
                } else {
                    // Update remaining time display
                    updateRemainingTime(timeLeft);
                }
            }, 1000); // Update every second
        }

        // Show session end reminder
        function showSessionEndReminder() {
            if (sessionActive && currentLabSession) {
                alert(
                    `‚è∞ Session Time Complete!\n\n` +
                    `Subject: ${currentLabSession.subject}\n` +
                    `Duration: ${currentLabSession.periods} periods completed\n\n` +
                    `Reports are automatically saved. You can end the session now.`
                );
            }
        }

        // Update remaining time display
        function updateRemainingTime(timeLeft) {
            const minutes = Math.floor(timeLeft / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            // Update the session info with remaining time
            const durationElement = document.getElementById('current-duration');
            if (durationElement && currentLabSession) {
                durationElement.innerHTML = `${currentLabSession.periods} periods (${currentLabSession.expectedDuration} min) - <span style="color: #e74c3c;">Time left: ${minutes}:${seconds.toString().padStart(2, '0')}</span>`;
            }
        }

        // Update session info display
        function updateSessionInfo(session) {
            document.getElementById('current-subject').textContent = session.subject;
            document.getElementById('current-faculty').textContent = session.faculty;
            document.getElementById('current-year').textContent = `${session.year}${session.year === 1 ? 'st' : session.year === 2 ? 'nd' : session.year === 3 ? 'rd' : 'th'} Year`;
            document.getElementById('current-department').textContent = session.department;
            document.getElementById('current-section').textContent = session.section === 'None' ? 'No Section' : `Section ${session.section}`;
            document.getElementById('current-duration').textContent = `${session.periods} periods (${session.expectedDuration} min)`;
            document.getElementById('current-start-time').textContent = new Date(session.startTime).toLocaleTimeString();
            
            // Update duration control display
            document.getElementById('current-periods-display').textContent = session.periods;
            document.getElementById('current-minutes-display').textContent = session.expectedDuration;
            
            document.getElementById('session-info').style.display = 'block';
        }
        
        // Hide session info
        function hideSessionInfo() {
            document.getElementById('session-info').style.display = 'none';
        }
        
        // Adjust session duration after it has started
        async function adjustSessionDuration(change) {
            if (!currentLabSession) {
                alert('‚ùå No active session to adjust.');
                return;
            }
            
            const newPeriods = currentLabSession.periods + change;
            
            // Validate limits
            if (newPeriods < 1) {
                alert('‚ùå Cannot reduce below 1 period (50 minutes).');
                return;
            }
            if (newPeriods > 6) {
                alert('‚ùå Cannot increase beyond 6 periods (300 minutes).');
                return;
            }
            
            const newDuration = newPeriods * 50;
            
            if (!confirm(`Adjust session duration?\n\nCurrent: ${currentLabSession.periods} periods (${currentLabSession.expectedDuration} min)\nNew: ${newPeriods} periods (${newDuration} min)\n\nThis will ${change > 0 ? 'extend' : 'reduce'} the session time.`)) {
                return;
            }
            
            try {
                // Update on server
                const response = await fetch('/api/update-session-duration', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        sessionId: currentLabSession._id,
                        periods: newPeriods,
                        expectedDuration: newDuration
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update local session data
                    currentLabSession.periods = newPeriods;
                    currentLabSession.expectedDuration = newDuration;
                    
                    // Recalculate end time
                    const now = new Date();
                    const startTime = new Date(currentLabSession.startTime);
                    const elapsed = now - startTime;
                    const remainingTime = (newDuration * 60 * 1000) - elapsed;
                    sessionEndTime = new Date(now.getTime() + remainingTime);
                    
                    // Update UI
                    document.getElementById('current-duration').textContent = `${newPeriods} periods (${newDuration} min)`;
                    document.getElementById('current-periods-display').textContent = newPeriods;
                    document.getElementById('current-minutes-display').textContent = newDuration;
                    
                    console.log('‚úÖ Session duration updated:', { periods: newPeriods, duration: newDuration });
                    alert(`‚úÖ Session duration ${change > 0 ? 'increased' : 'decreased'} successfully!\n\nNew duration: ${newPeriods} periods (${newDuration} minutes)\nSession will now end at: ${sessionEndTime.toLocaleTimeString()}`);
                } else {
                    alert('‚ùå Failed to update duration: ' + data.error);
                }
            } catch (error) {
                console.error('Error adjusting duration:', error);
                alert('‚ùå Error adjusting duration. Please try again.');
            }
        }
        
        // Adjust session by custom minutes
        async function adjustSessionByMinutes(action) {
            if (!currentLabSession) {
                alert('‚ùå No active session to adjust.');
                return;
            }
            
            const customMinutes = parseInt(document.getElementById('custom-time-input').value);
            
            if (!customMinutes || customMinutes < 5 || customMinutes > 100) {
                alert('‚ùå Please enter a valid time between 5 and 100 minutes.');
                return;
            }
            
            const changeInMinutes = action === 'increase' ? customMinutes : -customMinutes;
            const newDuration = currentLabSession.expectedDuration + changeInMinutes;
            
            // Validate limits (50-300 minutes = 1-6 periods)
            if (newDuration < 50) {
                alert('‚ùå Cannot reduce below 50 minutes (1 period).');
                return;
            }
            if (newDuration > 300) {
                alert('‚ùå Cannot increase beyond 300 minutes (6 periods).');
                return;
            }
            
            // Calculate periods (round to nearest 0.5)
            const newPeriods = Math.round((newDuration / 50) * 2) / 2;
            
            if (!confirm(`Adjust session duration by ${customMinutes} minutes?\n\nCurrent: ${currentLabSession.expectedDuration} min\nNew: ${newDuration} min (‚âà${newPeriods} periods)\n\nThis will ${action === 'increase' ? 'extend' : 'reduce'} the session time.`)) {
                return;
            }
            
            try {
                // Update on server with new duration
                const response = await fetch('/api/update-session-duration', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        sessionId: currentLabSession._id,
                        periods: newPeriods,
                        expectedDuration: newDuration
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update local session data
                    currentLabSession.periods = newPeriods;
                    currentLabSession.expectedDuration = newDuration;
                    
                    // Recalculate end time
                    const now = new Date();
                    const startTime = new Date(currentLabSession.startTime);
                    const elapsed = now - startTime;
                    const remainingTime = (newDuration * 60 * 1000) - elapsed;
                    sessionEndTime = new Date(now.getTime() + remainingTime);
                    
                    // Update UI
                    document.getElementById('current-duration').textContent = `${newPeriods} periods (${newDuration} min)`;
                    document.getElementById('current-periods-display').textContent = newPeriods;
                    document.getElementById('current-minutes-display').textContent = newDuration;
                    
                    console.log('‚úÖ Session duration updated:', { periods: newPeriods, duration: newDuration });
                    alert(`‚úÖ Session duration ${action === 'increase' ? 'increased' : 'decreased'} by ${customMinutes} minutes!\n\nNew duration: ${newPeriods} periods (${newDuration} minutes)\nSession will now end at: ${sessionEndTime.toLocaleTimeString()}`);
                } else {
                    alert('‚ùå Failed to update duration: ' + data.error);
                }
            } catch (error) {
                console.error('Error adjusting duration:', error);
                alert('‚ùå Error adjusting duration. Please try again.');
            }
        }

        // End lab session
        function endLabSession() {
            if (!currentLabSession) {
                alert('‚ùå No active session to end.');
                return;
            }

            if (confirm('‚ö†Ô∏è Are you sure you want to end the current lab session?\n\nThis will:\n‚Ä¢ Stop all screen monitoring\n‚Ä¢ Clear all session data\n‚Ä¢ Prepare for the next session')) {
                // Send end session request to server
                fetch('/api/end-lab-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sessionId: currentLabSession._id })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        sessionActive = false;
                        currentLabSession = null;
                        sessionEndTime = null;
                        
                        // Clear session timer
                        if (sessionTimer) {
                            clearInterval(sessionTimer);
                            sessionTimer = null;
                        }
                        
                        document.getElementById('startSessionBtn').disabled = false;
                        document.getElementById('endSessionBtn').disabled = true;
                        
                        // Stop all monitoring
                        monitoringConnections.forEach((pc, sessionId) => {
                            stopMonitoring(sessionId);
                        });
                        
                        // Clear students grid
                        document.getElementById('studentsGrid').innerHTML = '<div class="no-students">üì± No students connected. Students need to login via kiosk first.</div>';
                        connectedStudents.clear();
                        updateStats();
                        
                        // Hide session info
                        hideSessionInfo();
                        
                        console.log('üõë Lab session ended and data cleared');
                        alert('‚úÖ Session Completed!');
                    } else {
                        alert('‚ùå Failed to end session: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error ending session:', error);
                    alert('‚ùå Error ending session. Please try again.');
                });
            }
        }

        // Refresh student list
        function refreshStudentList() {
            console.log('üîÑ Refreshing student list...');
            loadActiveStudents();
        }

        // Export session data to CSV
        function exportSessionData() {
            console.log('üìä Exporting session data...');
            
            if (!currentLabSession) {
                alert('‚ùå No active lab session to export.');
                return;
            }
            
            // Fetch complete session data from server
            fetch(`/api/export-session-data/${currentLabSession._id}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('üìä Export data received:', data);
                    console.log('üìä Session data:', data.sessionData);
                    console.log('üìä Student records:', data.studentRecords);
                    generateCSVFile(data.sessionData, data.studentRecords);
                } else {
                    alert('‚ùå Failed to export session data: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error exporting session data:', error);
                alert('‚ùå Error exporting session data. Please try again.');
            });
        }

        // Generate CSV file from session data
        function generateCSVFile(sessionData, studentRecords) {
            const csvData = [];
            
            // Add session header information
            csvData.push(`Lab Session Report`);
            csvData.push(`Subject: ${sessionData.subject}`);
            csvData.push(`Faculty: ${sessionData.faculty}`);
            csvData.push(`Year: ${sessionData.year}${sessionData.year === 1 ? 'st' : sessionData.year === 2 ? 'nd' : sessionData.year === 3 ? 'rd' : 'th'} Year`);
            csvData.push(`Department: ${sessionData.department}`);
            csvData.push(`Section: ${sessionData.section === 'None' ? 'No Section' : 'Section ' + sessionData.section}`);
            csvData.push(`Duration: ${sessionData.periods} periods (${sessionData.expectedDuration} minutes)`);
            csvData.push(`Started: ${new Date(sessionData.startTime).toLocaleString()}`);
            csvData.push(`Generated: ${new Date().toLocaleString()}`);
            csvData.push(`Total Students: ${studentRecords.length}`);
            csvData.push(''); // Empty line
            
            // Add student data headers
            const headers = [
                'Sr. No',
                'System No',
                'Student Name', 
                'Roll Number', 
                'Login Time', 
                'Logout Time',
                'Duration (minutes)',
                'Status'
            ];
            csvData.push(headers.join(','));
            
            // Only show students who actually logged in
            studentRecords.forEach((record, index) => {
                const loginTime = new Date(record.loginTime).toLocaleString();
                const logoutTime = record.logoutTime ? new Date(record.logoutTime).toLocaleString() : 'Still Active';
                const duration = record.duration ? Math.round(record.duration / 60) : 'Ongoing';
                
                const row = [
                    index + 1,
                    `"${record.systemNumber || '-'}"`,
                    `"${record.studentName || '-'}"`,
                    `"${record.studentId || '-'}"`,
                    `"${loginTime}"`,
                    `"${logoutTime}"`,
                    `"${duration}"`,
                    `"${record.status === 'active' ? 'Present' : 'Completed'}"`
                ];
                csvData.push(row.join(','));
            });
            
            // Create and download CSV file
            const csvContent = csvData.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${sessionData.subject.replace(/[^a-zA-Z0-9]/g, '_')}_${sessionData.year}${sessionData.section !== 'None' ? '_' + sessionData.section : ''}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            console.log('‚úÖ Session CSV exported successfully');
            sessionExported = true; // Mark as exported
            alert(`‚úÖ Session data exported successfully!\n\nThe CSV includes ${studentRecords.length} students who logged in during this session.\n\n‚úì You can now end the session if needed.`);
        }

        // Debug session data
        function debugSessionData() {
            if (!currentLabSession) {
                alert('‚ùå No active lab session to debug.');
                return;
            }
            
            console.log('üîç Debugging session data...');
            
            // Fetch debug data from server
            fetch(`/api/debug-session-data/${currentLabSession._id}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('üîç Debug data received:', data.debug);
                    
                    // Show debug info in a popup
                    const debugInfo = `
Debug Information:

Lab Session ID: ${currentLabSession._id}
Lab Session Subject: ${data.debug.labSession?.subject || 'Not found'}
Lab Session Start Time: ${data.debug.labSession?.startTime || 'Not found'}

Recent Sessions (last 10):
${data.debug.recentSessions.map((s, i) => 
    `${i+1}. ${s.studentName} (${s.studentId}) - ${s.systemNumber} - ${new Date(s.loginTime).toLocaleString()}`
).join('\n')}

Active Sessions:
${data.debug.activeSessions.map((s, i) => 
    `${i+1}. ${s.studentName} (${s.studentId}) - ${s.systemNumber} - ${new Date(s.loginTime).toLocaleString()}`
).join('\n')}

Lab Session Student Records:
${data.debug.labSessionStudentRecords?.map((s, i) => 
    `${i+1}. ${s.studentName} (${s.studentId}) - ${s.systemNumber} - ${new Date(s.loginTime).toLocaleString()}`
).join('\n') || 'None found'}
                    `;
                    
                    alert(debugInfo);
                } else {
                    alert('‚ùå Failed to get debug data: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error getting debug data:', error);
                alert('‚ùå Error getting debug data. Check console for details.');
            });
        }

        // Force clear all sessions
        function forceClearSessions() {
            if (!confirm('‚ö†Ô∏è WARNING: This will clear ALL lab sessions and student data!\n\nAre you sure you want to continue?')) {
                return;
            }
            
            console.log('üßπ Force clearing all sessions...');
            
            fetch('/api/force-clear-all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ All sessions cleared successfully!\n\nYou can now start a new lab session.');
                    // Reset UI
                    currentLabSession = null;
                    sessionActive = false;
                    document.getElementById('session-info').style.display = 'none';
                    document.getElementById('startSessionBtn').disabled = false;
                    document.getElementById('endSessionBtn').disabled = true;
                    
                    // Clear all monitoring connections
                    monitoringConnections.forEach((pc, sessionId) => {
                        if (pc) {
                            pc.close();
                        }
                    });
                    monitoringConnections.clear();
                    
                    // Clear students grid immediately
                    document.getElementById('studentsGrid').innerHTML = '<div class="no-students">üì± No students connected. Students need to login via kiosk first.</div>';
                    connectedStudents.clear();
                    updateStats();
                    
                    // Then refresh to get any remaining active sessions
                    setTimeout(() => {
                        refreshStudentList();
                    }, 500);
                } else {
                    alert('‚ùå Failed to clear sessions: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error clearing sessions:', error);
                alert('‚ùå Error clearing sessions. Check console for details.');
            });
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const fullscreenModal = document.getElementById('fullscreen-modal');
                if (fullscreenModal.classList.contains('active')) {
                    closeFullscreen();
                }
            }
        });

        // =============================================================================
        // AUTOMATIC REPORT SCHEDULING FUNCTIONS
        // =============================================================================

        // Load current schedule for selected lab
        async function loadSchedule() {
            const labId = document.getElementById('scheduleLabId').value;
            const statusDiv = document.getElementById('scheduleStatus');
            
            try {
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = '‚è≥ Loading schedules...';
                
                const response = await fetch(`/api/report-schedule/${labId}`);
                const data = await response.json();
                
                if (data.success) {
                    // Load schedule 1
                    if (data.schedule.scheduleTime1) {
                        document.getElementById('scheduleTime1').value = data.schedule.scheduleTime1;
                        document.getElementById('scheduleEnabled1').checked = data.schedule.enabled1 !== false;
                    }
                    
                    // Load schedule 2
                    if (data.schedule.scheduleTime2) {
                        document.getElementById('scheduleTime2').value = data.schedule.scheduleTime2;
                        document.getElementById('scheduleEnabled2').checked = data.schedule.enabled2 !== false;
                    }
                    
                    // Legacy support - if old format, load into schedule 1
                    if (data.schedule.scheduleTime && !data.schedule.scheduleTime1) {
                        document.getElementById('scheduleTime1').value = data.schedule.scheduleTime;
                        document.getElementById('scheduleEnabled1').checked = data.schedule.enabled;
                    }
                    
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                    const schedule1Status = document.getElementById('scheduleEnabled1').checked ? 'üü¢ Enabled' : 'üî¥ Disabled';
                    const schedule2Status = document.getElementById('scheduleEnabled2').checked ? 'üü¢ Enabled' : 'üî¥ Disabled';
                    statusDiv.innerHTML = `
                        ‚úÖ Schedules loaded for ${labId}<br>
                        <strong>Schedule 1:</strong> ${document.getElementById('scheduleTime1').value} - ${schedule1Status}<br>
                        <strong>Schedule 2:</strong> ${document.getElementById('scheduleTime2').value} - ${schedule2Status}
                        ${data.schedule.lastGenerated ? '<br><strong>Last Generated:</strong> ' + new Date(data.schedule.lastGenerated).toLocaleString() : ''}
                    `;
                } else {
                    throw new Error(data.error || 'Failed to load schedule');
                }
            } catch (error) {
                console.error('Error loading schedule:', error);
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }

        // Save schedule configuration
        async function saveSchedule() {
            const labId = document.getElementById('scheduleLabId').value;
            const scheduleTime1 = document.getElementById('scheduleTime1').value;
            const enabled1 = document.getElementById('scheduleEnabled1').checked;
            const scheduleTime2 = document.getElementById('scheduleTime2').value;
            const enabled2 = document.getElementById('scheduleEnabled2').checked;
            const statusDiv = document.getElementById('scheduleStatus');
            
            if (!scheduleTime1 && !scheduleTime2) {
                alert('Please select at least one schedule time');
                return;
            }
            
            try {
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = '‚è≥ Saving schedules...';
                
                const response = await fetch('/api/report-schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        labId, 
                        scheduleTime1, 
                        enabled1,
                        scheduleTime2,
                        enabled2
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                    
                    let statusHTML = `‚úÖ Schedules saved successfully!<br><strong>Lab:</strong> ${labId}<br>`;
                    
                    if (scheduleTime1 && enabled1) {
                        statusHTML += `<strong>Schedule 1:</strong> ${scheduleTime1} - üü¢ Enabled<br>`;
                    }
                    if (scheduleTime2 && enabled2) {
                        statusHTML += `<strong>Schedule 2:</strong> ${scheduleTime2} - üü¢ Enabled<br>`;
                    }
                    
                    statusHTML += `<em>Reports will automatically download to your browser at the scheduled times every day.</em>`;
                    
                    statusDiv.innerHTML = statusHTML;
                    console.log('‚úÖ Schedules saved:', data.schedule);
                } else {
                    throw new Error(data.error || 'Failed to save schedule');
                }
            } catch (error) {
                console.error('Error saving schedule:', error);
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }

        // Generate report immediately for testing - downloads to browser
        async function generateReportNow() {
            const labId = document.getElementById('scheduleLabId').value;
            const statusDiv = document.getElementById('scheduleStatus');
            
            if (!confirm(`Generate and download report now for ${labId}?\n\nThis will download a CSV file with today's sessions to your computer.`)) {
                return;
            }
            
            try {
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = '‚è≥ Generating report...';
                
                const response = await fetch('/api/generate-report-now', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ labId })
                });
                
                if (response.ok) {
                    // Get filename from Content-Disposition header
                    const contentDisposition = response.headers.get('Content-Disposition');
                    const filenameMatch = contentDisposition && contentDisposition.match(/filename="(.+)"/);
                    const filename = filenameMatch ? filenameMatch[1] : `${labId}-sessions-${new Date().toISOString().split('T')[0]}.csv`;
                    
                    // Get CSV content
                    const blob = await response.blob();
                    
                    // Create download link
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.innerHTML = `
                        ‚úÖ Report downloaded successfully!<br>
                        <strong>Filename:</strong> ${filename}<br>
                        <em>Check your Downloads folder</em>
                    `;
                    console.log('‚úÖ Report downloaded:', filename);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to generate report');
                }
            } catch (error) {
                console.error('Error generating report:', error);
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }

        // =============================================================================
        // END AUTOMATIC REPORT SCHEDULING FUNCTIONS
        // =============================================================================

        // Load active students on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ Admin dashboard DOM loaded');
            initializeSocket();
        });

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Load initial schedule on page load
            loadSchedule();
            
            // Auto-load schedule when lab changes
            document.getElementById('scheduleLabId').addEventListener('change', loadSchedule);
        });
    </script>
</body>
</html>
