<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Central Admin Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.socket.io/4.7.0/socket.io.min.js" crossorigin="anonymous"></script>
<style>
  body {
    padding: 20px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  #systemList tr {
    cursor: pointer;
  }
  .modal-content img {
    max-width: 100%;
    max-height: 100vh;
  }
</style>
</head>
<body>
  <h1>üñ•Ô∏è Central Admin Dashboard</h1>
  <div class="mb-3">
    <label for="labFilter" class="form-label"><strong>Filter by Lab:</strong></label>
    <select id="labFilter" class="form-select" style="max-width: 200px;">
      <option value="" selected>All Labs</option>
      <option value="LAB-01">LAB-01</option>
      <option value="LAB-02">LAB-02</option>
      <option value="LAB-03">LAB-03</option>
      <!-- Add more lab options here -->
    </select>
  </div>
  <div>
    <table class="table table-striped" id="systemList">
      <thead>
        <tr>
          <th>Student Name</th>
          <th>Student ID</th>
          <th>Computer Name</th>
          <th>Lab</th>
          <th>System Number</th>
          <th>Login Time</th>
        </tr>
      </thead>
      <tbody>
        <!-- Active session rows here -->
      </tbody>
    </table>
  </div>

  <!-- Modal for Full Screen View -->
  <div class="modal fade" id="screenModal" tabindex="-1" aria-labelledby="screenModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header">
          <h5 class="modal-title" id="screenModalLabel">Live Screen</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body d-flex justify-content-center align-items-center">
          <img id="liveScreenImg" alt="Screen Feed" />
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const socket = io();

  let currentLabFilter = "";
  let sessions = [];
  let selectedSessionId = null;

  const labFilterEl = document.getElementById('labFilter');
  const systemListBody = document.querySelector('#systemList tbody');
  const screenModal = new bootstrap.Modal(document.getElementById('screenModal'));
  const liveScreenImg = document.getElementById('liveScreenImg');

  // Fetch active sessions for specific lab or all
  async function fetchSessions(labFilter = "") {
    const url = labFilter ? `/api/active-sessions/${labFilter}` : "/api/active-sessions/all";
    try {
      const response = await fetch(url);
      const data = await response.json();
      if(data.success) {
        sessions = data.sessions || [];
        renderSessionList();
      } else {
        systemListBody.innerHTML = '<tr><td colspan="6">Failed to load sessions.</td></tr>';
      }
    } catch {
      systemListBody.innerHTML = '<tr><td colspan="6">Unable to connect to server.</td></tr>';
    }
  }

  // Render session list table
  function renderSessionList() {
    if(sessions.length === 0) {
      systemListBody.innerHTML = '<tr><td colspan="6">No active sessions found.</td></tr>';
      return;
    }
    systemListBody.innerHTML = sessions.map(s => `
      <tr data-session-id="${s._id}">
        <td>${s.studentName}</td>
        <td>${s.studentId}</td>
        <td>${s.computerName}</td>
        <td>${s.labId}</td>
        <td>${s.systemNumber}</td>
        <td>${new Date(s.loginTime).toLocaleString()}</td>
      </tr>
    `).join('');
  }

  // Handle click on session row to open full screen
  systemListBody.addEventListener('click', (e) => {
    const tr = e.target.closest('tr');
    if(tr) {
      selectedSessionId = tr.getAttribute('data-session-id');
      document.getElementById('screenModalLabel').textContent = `Live Screen - ${tr.children[0].textContent} (${tr.children[2].textContent})`;
      liveScreenImg.src = ""; // Clear old image
      screenModal.show();
    }
  });

  // Listen for live screen updates from socket
  socket.on('screenshot-update', data => {
    if(data.sessionId === selectedSessionId) {
      liveScreenImg.src = data.screenshot;
    }
  });

  labFilterEl.addEventListener('change', () => {
    currentLabFilter = labFilterEl.value;
    fetchSessions(currentLabFilter);
  });

  // Initial load
  fetchSessions(currentLabFilter);

  // Optionally, refresh sessions every 30 seconds
  setInterval(() => {
    fetchSessions(currentLabFilter);
  }, 30000);
</script>
</body>
</html>
